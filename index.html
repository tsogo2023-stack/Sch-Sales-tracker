<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Order Tracker</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #f0f2f5;
  --card-bg: #fff;
  --text: #1a1a2e;
  --text-light: #6b7280;
  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --danger: #ef4444;
  --warning: #f59e0b;
  --success: #10b981;
  --border: #e5e7eb;
  --shadow: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
  --radius: 8px;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* Top Bar */
.topbar {
  background: linear-gradient(135deg, #1e3a5f, #2563eb);
  color: #fff;
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.topbar h1 { font-size: 1.3rem; font-weight: 700; }
.topbar-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.topbar-actions button, .topbar-actions select {
  padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.15); color: #fff; cursor: pointer; font-size: 0.85rem;
  transition: background 0.2s;
}
.topbar-actions button:hover, .topbar-actions select:hover { background: rgba(255,255,255,0.3); }
.topbar-actions select option { color: #333; background: #fff; }

/* Toolbar */
.toolbar {
  padding: 12px 24px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  background: #fff;
  border-bottom: 1px solid var(--border);
}
.toolbar input[type="text"] {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 0.9rem; width: 220px;
}
.toolbar select {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 0.9rem; background: #fff;
}
.btn {
  padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
  font-size: 0.85rem; font-weight: 600; transition: all 0.2s;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #059669; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #dc2626; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-warning:hover { background: #d97706; }
.btn-sm { padding: 4px 10px; font-size: 0.78rem; }

/* Stats Bar */
.stats-bar {
  padding: 10px 24px;
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  background: #fff;
  border-bottom: 1px solid var(--border);
}
.stat-item {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.85rem; color: var(--text-light);
}
.stat-num {
  font-weight: 700; font-size: 1.1rem; color: var(--text);
}
.stat-warning { color: var(--danger); }

/* Board */
.board-container {
  overflow-x: auto;
  padding: 16px 16px 24px;
}
.board {
  min-height: calc(100vh - 200px);
}
/* Board grid: rows = orders, columns = stages */
.board-grid {
  display: grid;
  gap: 0;
  min-width: max-content;
  border-top: 1px solid var(--border);
  border-left: 1px solid var(--border);
}
.board-grid-header-cell {
  background: #fff;
  border-right: 1px solid var(--border);
  border-bottom: 2px solid var(--primary);
  padding: 10px 14px;
  font-weight: 700;
  font-size: 0.85rem;
  position: sticky;
  top: 0;
  z-index: 10;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}
.column-count {
  background: var(--primary);
  color: #fff;
  border-radius: 50%;
  width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem;
  flex-shrink: 0;
}
.board-grid-cell {
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  padding: 8px;
  min-width: 230px;
  min-height: 90px;
  vertical-align: top;
  cursor: pointer;
  transition: filter 0.15s;
}
.board-grid-cell:hover { filter: brightness(0.97); }
.board-grid-cell-type {
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  min-width: 0;
  min-height: 90px;
  padding: 6px 4px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  transition: filter 0.15s;
}
.board-grid-cell-type:hover { filter: brightness(0.97); }
.board-grid-cell.cell-current {
  border-right: 2px solid var(--primary);
  border-bottom: 2px solid var(--primary);
}
.board-grid-cell.cell-empty {
  background: #f4f6f8;
  opacity: 0.45;
  cursor: default;
}
.board-grid-cell.cell-empty:hover { filter: none; }
/* Row color tints (8 colors, one per order) */
.row-color-0 { background: #eff6ff; }
.row-color-1 { background: #f0fdf4; }
.row-color-2 { background: #fffbeb; }
.row-color-3 { background: #fef2f2; }
.row-color-4 { background: #f5f3ff; }
.row-color-5 { background: #fdf4ff; }
.row-color-6 { background: #ecfeff; }
.row-color-7 { background: #f7fee7; }

/* Order Card */
.order-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 12px;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: box-shadow 0.2s, transform 0.1s;
  border-left: 4px solid var(--primary);
}
.order-card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-1px);
}
.order-card.stuck { border-left-color: var(--danger); background: #fef2f2; }
.order-card.warning { border-left-color: var(--warning); background: #fffbeb; }
.order-card.past-stage { border-left: 4px dashed #a3b8cc; background: #f8fafc; opacity: 0.82; }
.order-card .card-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
.order-card .card-desc {
  font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 230px;
}
.order-card .card-client {
  font-size: 0.78rem; color: var(--text-light); margin-bottom: 4px;
  display: flex; align-items: center; gap: 4px;
}
.order-card .card-meta {
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 4px;
}
.client-dot {
  width: 8px; height: 8px; border-radius: 50%; display: inline-block;
}
.order-card .card-days {
  font-size: 0.75rem; padding: 2px 8px; border-radius: 12px;
  display: inline-block;
}
.badge {
  font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; display: inline-block; font-weight: 600;
}
.badge-review { background: #ede9fe; color: #7c3aed; }
.badge-invoice { background: #e0f2fe; color: #0369a1; }
.badge-payment { background: #dcfce7; color: #16a34a; }
.badge-unpaid { background: #fef2f2; color: #dc2626; }
.days-ok { background: #ecfdf5; color: #059669; }
.days-warn { background: #fffbeb; color: #d97706; }
.days-danger { background: #fef2f2; color: #dc2626; }

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff;
  border-radius: 12px;
  padding: 0;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.modal-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-header h2 { font-size: 1.1rem; }
.modal-close {
  background: none; border: none; font-size: 1.5rem; cursor: pointer;
  color: var(--text-light); padding: 4px 8px; border-radius: 4px;
}
.modal-close:hover { background: #f3f4f6; }
.modal-body { padding: 20px; }
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; }
.form-group input, .form-group select, .form-group textarea {
  width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 0.9rem; font-family: inherit;
}
.form-group textarea { resize: vertical; min-height: 60px; }
.form-row { display: flex; gap: 12px; }
.form-row .form-group { flex: 1; }
.modal-footer {
  padding: 14px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  flex-wrap: wrap;
}

/* Detail sections */
.detail-stage {
  background: #f0f7ff;
  padding: 10px 14px;
  border-radius: 8px;
  margin-bottom: 14px;
  font-weight: 600;
  color: var(--primary);
}
.detail-section {
  background: #f8f9fb;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}
.detail-section h4 {
  margin-bottom: 8px;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
}
.finance-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 0.85rem;
}
.finance-row.total {
  font-weight: 700;
  border-top: 2px solid var(--border);
  margin-top: 4px;
  padding-top: 8px;
}
.finance-row .remaining { color: var(--danger); font-weight: 700; }
.finance-row .paid-full { color: var(--success); font-weight: 700; }
.payment-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.83rem;
}
.payment-item:last-child { border-bottom: none; }
.history-list { list-style: none; }
.history-item {
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.85rem;
  display: flex;
  gap: 8px;
}
.history-date { color: var(--text-light); min-width: 90px; }
.history-text { flex: 1; }
.note-item {
  background: #fffbeb;
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 0.85rem;
  border-left: 3px solid var(--warning);
}
.note-date { font-size: 0.75rem; color: var(--text-light); }
.review-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #ede9fe;
  color: #7c3aed;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
}

/* Client color palette */
.client-color-0 { background: #3b82f6; }
.client-color-1 { background: #10b981; }
.client-color-2 { background: #f59e0b; }
.client-color-3 { background: #ef4444; }
.client-color-4 { background: #8b5cf6; }
.client-color-5 { background: #ec4899; }
.client-color-6 { background: #06b6d4; }
.client-color-7 { background: #84cc16; }

/* View toggle */
.view-table { display: none; padding: 16px 24px; }
.view-table.active { display: block; }
.board-container.hidden { display: none; }
table.orders-table {
  width: 100%; border-collapse: collapse; background: #fff;
  border-radius: var(--radius); overflow: hidden;
  box-shadow: var(--shadow);
}
.orders-table th, .orders-table td {
  padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border);
  font-size: 0.85rem;
}
.orders-table th { background: #f8f9fb; font-weight: 700; }
.orders-table tr:hover { background: #f8f9fb; cursor: pointer; }

/* Tabs in detail modal */
.detail-tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--border);
  margin-bottom: 14px;
}
.detail-tab {
  padding: 8px 16px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  color: var(--text-light);
  transition: all 0.2s;
}
.detail-tab:hover { color: var(--text); }
.detail-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-content { display: none; }
.tab-content.active { display: block; }

@media (max-width: 768px) {
  .topbar { padding: 10px 12px; }
  .topbar h1 { font-size: 1rem; }
  .toolbar { padding: 8px 12px; }
  .toolbar input[type="text"] { width: 150px; }
  .column { min-width: 200px; }
  .form-row { flex-direction: column; gap: 0; }
}
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>

<!-- Login Gate -->
<div id="passwordGate" style="display:none;position:fixed;inset:0;background:linear-gradient(135deg,#1e3a5f,#2563eb);z-index:9999;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:16px;padding:40px;width:360px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
    <div style="font-size:2.5rem;margin-bottom:12px">ğŸ”’</div>
    <h2 style="margin-bottom:6px;color:#1e3a5f;font-size:1.4rem">Sales Order Tracker</h2>
    <p style="color:#6b7280;font-size:0.85rem;margin-bottom:24px">Sign in to continue</p>
    <input id="emailInput" type="email" placeholder="Email address" autocomplete="email"
      onkeydown="if(event.key==='Enter')document.getElementById('pwInput').focus()"
      style="width:100%;padding:10px 14px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;margin-bottom:10px;outline:none;box-sizing:border-box">
    <input id="pwInput" type="password" placeholder="Password" autocomplete="current-password"
      onkeydown="if(event.key==='Enter')doLogin()"
      style="width:100%;padding:10px 14px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;margin-bottom:12px;outline:none;box-sizing:border-box">
    <div id="pwError" style="color:#ef4444;font-size:0.8rem;margin-bottom:10px;display:none;text-align:left;padding:0 2px"></div>
    <button id="loginBtn" onclick="doLogin()" style="width:100%;padding:11px;background:#2563eb;color:#fff;border:none;border-radius:8px;font-size:1rem;cursor:pointer;font-weight:600">Sign In</button>
  </div>
</div>

<!-- Top Bar -->
<div class="topbar">
  <h1 id="appTitle"></h1>
  <div class="topbar-actions">
    <span id="syncStatus" style="display:inline-flex;align-items:center;gap:4px;font-size:0.75rem;padding:4px 10px;border-radius:12px;background:rgba(255,255,255,0.15)">
      <span id="syncDot" style="width:8px;height:8px;border-radius:50%;background:#f59e0b"></span>
      <span id="syncText">Connecting...</span>
    </span>
    <button onclick="toggleLang()" id="btnLang"></button>
    <button onclick="toggleView()" id="btnView"></button>
    <button id="btnExport" onclick="exportData()">ğŸ’¾ Export</button>
    <label id="lblImport" style="cursor:pointer">
      <button onclick="this.nextElementSibling.click()">ğŸ“‚ Import</button>
      <input type="file" accept=".json" style="display:none" onchange="importData(event)">
    </label>
    <span id="clientViewLabel" style="display:none;font-size:0.8rem;padding:4px 10px;border-radius:12px;background:rgba(255,255,255,0.25);font-weight:600"></span>
    <button id="btnSignOut" onclick="doSignOut()" style="display:none">ğŸšª Sign Out</button>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <button class="btn btn-primary" onclick="openNewOrderModal()" id="btnNewOrder"></button>
  <button class="btn btn-success" onclick="openClientModal()" id="btnManageClients"></button>
  <input type="text" id="searchInput" oninput="renderBoard()">
  <select id="filterClient" onchange="renderBoard()"></select>
  <select id="filterStage" onchange="renderBoard()"></select>
  <select id="filterYear" onchange="renderBoard()"></select>
</div>

<!-- Stats -->
<div class="stats-bar" id="statsBar"></div>

<!-- Kanban Board -->
<div class="board-container" id="boardContainer">
  <div class="board" id="board"></div>
</div>

<!-- Table View -->
<div class="view-table" id="tableView">
  <table class="orders-table">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- New Order Modal -->
<div class="modal-overlay" id="newOrderModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalNewTitle"></h2>
      <button class="modal-close" onclick="closeModal('newOrderModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label id="lblOrderType" style="margin-bottom:8px"></label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600;transition:border-color 0.15s" id="typeLblDrawing">
            <input type="radio" name="inputOrderType" value="drawing" checked style="accent-color:var(--primary)"> ğŸ“ <span id="typeNameDrawing"></span>
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600;transition:border-color 0.15s" id="typeLblMaterial">
            <input type="radio" name="inputOrderType" value="material" style="accent-color:var(--primary)"> ğŸ“‹ <span id="typeNameMaterial"></span>
          </label>
          <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600;transition:border-color 0.15s" id="typeLblLicense">
            <input type="radio" name="inputOrderType" value="license" style="accent-color:var(--primary)"> ğŸ”‘ <span id="typeNameLicense"></span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label id="lblOrderName">Order / Drawing Name</label>
        <input type="text" id="inputOrderName">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label id="lblClient">Client</label>
          <select id="inputOrderClient"></select>
        </div>
        <div class="form-group" style="max-width:110px">
          <label id="lblYear"></label>
          <input type="number" id="inputOrderYear" min="2020" max="2099" style="width:100%">
        </div>
      </div>
      <div class="form-group">
        <label id="lblDescription">Description</label>
        <textarea id="inputOrderDesc" rows="2"></textarea>
      </div>
      <div style="background:#f0f7ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;margin-bottom:14px">
        <h4 style="font-size:0.85rem;color:var(--primary);margin-bottom:10px" id="lblEmailInfo">ğŸ“§ Email / Source Information</h4>
        <div class="form-row">
          <div class="form-group">
            <label id="lblReceivedFrom">Received From (sender)</label>
            <input type="text" id="inputReceivedFrom" placeholder="">
          </div>
          <div class="form-group">
            <label id="lblReceivedDate">Date Received</label>
            <input type="date" id="inputReceivedDate">
          </div>
        </div>
        <div class="form-group">
          <label id="lblEmailSubject">Email Subject / Title</label>
          <input type="text" id="inputEmailSubject" placeholder="">
        </div>
      </div>
      <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:12px;margin-bottom:14px">
        <h4 style="font-size:0.85rem;color:var(--success);margin-bottom:10px" id="lblFilesSection">ğŸ“ Drawing Files</h4>
        <div class="form-group">
          <label id="lblFilePath">File Location / Folder Path</label>
          <input type="text" id="inputFilePath" placeholder="C:\...">
        </div>
        <div class="form-group">
          <label id="lblAttachment1">Attachment 1</label>
          <input type="text" id="inputAttach1" placeholder="">
        </div>
        <div class="form-group">
          <label id="lblAttachment2">Attachment 2</label>
          <input type="text" id="inputAttach2" placeholder="">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label id="lblAttachment3">Attachment 3</label>
          <input type="text" id="inputAttach3" placeholder="">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('newOrderModal')" id="btnCancel1">Cancel</button>
      <button class="btn btn-primary" onclick="saveNewOrder()" id="btnSaveOrder">Save Order</button>
    </div>
  </div>
</div>

<!-- Order Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <h2 id="detailTitle"></h2>
      <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer" id="detailFooter"></div>
  </div>
</div>

<!-- Client Manager Modal -->
<div class="modal-overlay" id="clientModal">
  <div class="modal" style="max-width:450px">
    <div class="modal-header">
      <h2 id="modalClientTitle">Manage Clients</h2>
      <button class="modal-close" onclick="closeModal('clientModal')">&times;</button>
    </div>
    <div class="modal-body" id="clientBody"></div>
    <div class="modal-footer">
      <div style="display:flex;gap:6px;width:100%">
        <input type="text" id="newClientName" style="flex:1;padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px">
        <button class="btn btn-primary" onclick="addClient()" id="btnAddClient">Add</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== AUTH =====
let auth = null; // assigned after Firebase init below

function showGate() {
  const gate = document.getElementById('passwordGate');
  gate.style.display = 'flex';
  setTimeout(() => { const e = document.getElementById('emailInput'); if (e) e.focus(); }, 100);
}
function hideGate() {
  document.getElementById('passwordGate').style.display = 'none';
  document.getElementById('pwError').style.display = 'none';
}

function populateSession(profile) {
  sessionStorage.setItem('sch_auth',        '1');
  sessionStorage.setItem('sch_role',         profile.role         || 'client');
  sessionStorage.setItem('sch_client',       profile.clientFilter || '');
  sessionStorage.setItem('sch_lang_default', profile.langDefault  || 'mn');
  sessionStorage.setItem('sch_lang_alt',     profile.langAlt      || 'en');
  const btn = document.getElementById('btnSignOut');
  if (btn) btn.style.display = '';
  hideGate();
}
function clearSession() {
  ['sch_auth','sch_role','sch_client','sch_lang_default','sch_lang_alt'].forEach(k => sessionStorage.removeItem(k));
  const btn = document.getElementById('btnSignOut');
  if (btn) btn.style.display = 'none';
}
function showLoginError(msg) {
  const el = document.getElementById('pwError');
  el.textContent = msg;
  el.style.display = 'block';
  const btn = document.getElementById('loginBtn');
  if (btn) { btn.disabled = false; btn.textContent = 'Sign In'; }
}

async function doLogin() {
  if (!auth) { showLoginError('Auth service not ready. Refresh and try again.'); return; }
  const email    = (document.getElementById('emailInput').value || '').trim();
  const password = document.getElementById('pwInput').value || '';
  if (!email || !password) { showLoginError('Please enter email and password.'); return; }
  const btn = document.getElementById('loginBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Signing in...'; }
  document.getElementById('pwError').style.display = 'none';
  try {
    await firebase.auth().signInWithEmailAndPassword(email, password);
    // onAuthStateChanged observer fires next and handles the rest
  } catch (err) {
    const map = {
      'auth/user-not-found':         'No account found with this email.',
      'auth/wrong-password':         'Incorrect password. Please try again.',
      'auth/invalid-email':          'Please enter a valid email address.',
      'auth/user-disabled':          'This account has been disabled.',
      'auth/too-many-requests':      'Too many attempts. Try again later.',
      'auth/network-request-failed': 'Network error. Check your connection.',
      'auth/invalid-credential':     'Incorrect email or password.'
    };
    showLoginError(map[err.code] || 'Sign-in failed. Please try again.');
  }
}

async function doSignOut() {
  try { await firebase.auth().signOut(); } catch(e) { console.warn('Sign-out error:', e); }
  clearSession();
  state.lang = 'mn';
  document.getElementById('emailInput').value = '';
  document.getElementById('pwInput').value = '';
  showGate();
}

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyD_ltbKwEfC22nNsH_teHfACUtqnQremKU",
  authDomain: "sales-tracker-sch.firebaseapp.com",
  databaseURL: "https://sales-tracker-sch-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sales-tracker-sch",
  storageBucket: "sales-tracker-sch.firebasestorage.app",
  messagingSenderId: "808674424820",
  appId: "1:808674424820:web:547edae56262888f602ba1"
};

let db = null;
let firebaseReady = false;
let isSaving = false; // prevent loops when Firebase pushes data back

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  auth = firebase.auth();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); // token survives browser restart
  firebaseReady = true;
} catch(e) {
  console.warn('Firebase init failed, using offline mode:', e);
}

// Auth state observer â€” single entry point for post-login app startup
// Fires on every page load (restores session if token exists) and after sign-in/out
if (auth) {
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      try {
        const snap = await db.ref('userProfiles/' + user.uid).once('value');
        const profile = snap.val();
        if (!profile) {
          // Valid Firebase user but no profile configured â€” block access
          await firebase.auth().signOut();
          showLoginError('Account not configured. Please contact admin.');
          showGate();
          return;
        }
        populateSession(profile);
        state.lang = profile.langDefault || 'mn';
        saveState();
        loadState();
        updateUI();
        setupFirebaseSync();
      } catch(err) {
        console.warn('Profile fetch failed:', err);
        showLoginError('Could not load your profile. Try again.');
        showGate();
      }
    } else {
      // No signed-in user â€” show the login gate
      clearSession();
      showGate();
    }
  });
} else {
  // Auth SDK not available (offline / blocked CDN) â€” show gate, login will fail gracefully
  showGate();
}

// ===== DATA =====
const STAGES = [
  { id: 'drawing_received',    en: 'ğŸ“¥ Drawing Received',      mn: 'ğŸ“¥ Ğ—ÑƒÑ€Ğ°Ğ³ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½',                   ka: 'ğŸ“¥ áƒœáƒáƒ®áƒáƒ–áƒ˜ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ' },
  { id: 'review',              en: 'ğŸ” Review & Correction',   mn: 'ğŸ” Ğ¥ÑĞ½Ğ°Ñ… & Ğ—Ğ°ÑĞ°Ñ…',                        ka: 'ğŸ” áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ & áƒ™áƒáƒ áƒ”áƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ' },
  { id: 'sent_to_client',      en: 'ğŸ“¤ Sent to Client',        mn: 'ğŸ“¤ Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ´ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½',                 ka: 'ğŸ“¤ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ—áƒáƒœ' },
  { id: 'client_approved',     en: 'âœ… Client Approved',        mn: 'âœ… Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡ Ğ·Ó©Ğ²ÑˆÓ©Ó©Ñ€ÑÓ©Ğ½',                ka: 'âœ… áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ›áƒ áƒ“áƒáƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ' },
  { id: 'sent_abroad',         en: 'ğŸ‡©ğŸ‡ª Sent to DE/GE',        mn: 'ğŸ‡©ğŸ‡ª Ğ“ĞµÑ€Ğ¼Ğ°Ğ½/Ğ“Ò¯Ñ€Ğ¶ Ñ€ÑƒÑƒ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½',          ka: 'ğŸ‡©ğŸ‡ª áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ áƒ’áƒ”áƒ áƒ›/áƒ¡áƒáƒ¥-áƒ¨áƒ˜' },
  { id: 'calculation_received',en: 'ğŸ“Š Calculation Received',  mn: 'ğŸ“Š Ğ¢Ğ¾Ğ¾Ñ†Ğ¾Ğ¾ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½',                 ka: 'ğŸ“Š áƒ™áƒáƒšáƒ™áƒ£áƒšáƒáƒªáƒ˜áƒ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ' },
  { id: 'forwarded_mn',        en: 'ğŸ‡²ğŸ‡³ Forwarded (MN)',       mn: 'ğŸ‡²ğŸ‡³ Ğ¢Ğ¾Ğ¾Ñ†Ğ¾Ğ¾Ğ»Ğ»Ñ‹Ğ³ Ñ…Ğ°Ñ€Ğ¸Ğ»Ñ†Ğ°Ğ³Ñ‡ Ñ€ÑƒÑƒ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½', ka: 'ğŸ‡²ğŸ‡³ áƒ’áƒáƒ“áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ (MN)' },
  { id: 'proforma',            en: 'ğŸ“„ Proforma Invoice',      mn: 'ğŸ“„ ĞŸÑ€Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ° Ğ½ÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»',                  ka: 'ğŸ“„ áƒáƒ áƒáƒ¤áƒáƒ áƒ›áƒ-áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜' },
  { id: 'payment',             en: 'ğŸ’° Payment',               mn: 'ğŸ’° Ğ¢Ó©Ğ»Ğ±Ó©Ñ€',                              ka: 'ğŸ’° áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ' },
  { id: 'transport',           en: 'ğŸšš Transport',             mn: 'ğŸšš Ğ¢ÑÑĞ²ÑÑ€Ğ»ÑĞ»Ñ‚',                          ka: 'ğŸšš áƒ¢áƒ áƒáƒœáƒ¡áƒáƒáƒ áƒ¢áƒ˜' },
  { id: 'documents_sent',      en: 'ğŸ“‹ Documents Sent',        mn: 'ğŸ“‹ Ğ‘Ğ¸Ñ‡Ğ¸Ğ³ Ğ±Ğ°Ñ€Ğ¸Ğ¼Ñ‚ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½',               ka: 'ğŸ“‹ áƒ“áƒáƒ™áƒ£áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ' },
  { id: 'completed',           en: 'âœ”ï¸ Completed',             mn: 'âœ”ï¸ Ğ”ÑƒÑƒÑÑĞ°Ğ½',                             ka: 'âœ”ï¸ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜áƒ' }
];

const TRANSLATIONS = {
  en: {
    title: 'ğŸ“Š Sales Order Tracker',
    newOrder: '+ New Order',
    clients: 'ğŸ‘¥ Clients',
    search: 'Search orders...',
    allClients: 'All Clients',
    allStages: 'All Stages',
    allYears: 'All Years',
    year: 'Year',
    orderType: 'Order Type',
    typeDrawing: 'Drawing',
    typeMaterial: 'Material List',
    typeLicense: 'License',
    typeCol: 'Type',
    tableView: 'ğŸ“‹ Table View',
    boardView: 'ğŸ“Š Board View',
    export: 'ğŸ’¾ Export',
    import: 'ğŸ“‚ Import',
    orderName: 'Order / Drawing Name',
    client: 'Client',
    description: 'Description',
    invoiceAmount: 'Invoice Amount (EUR)',
    cancel: 'Cancel',
    save: 'Save Order',
    manageClients: 'Manage Clients',
    addClient: 'Add',
    newOrderTitle: 'New Order',
    nextStage: 'Next Stage â¡ï¸',
    prevStage: 'â¬…ï¸ Previous',
    sendBackReview: 'ğŸ”„ Send Back for Revision',
    deleteOrder: 'ğŸ—‘ï¸ Delete',
    addNote: 'Add Note',
    notes: 'Notes',
    history: 'History',
    finance: 'Finance',
    info: 'Info',
    stage: 'Current Stage',
    daysHere: 'days here',
    day: 'day',
    days: 'days',
    totalOrders: 'Total Orders',
    activeOrders: 'Active',
    stuckOrders: 'Stuck (7+ days)',
    completedOrders: 'Completed',
    totalInvoiced: 'Total Invoiced',
    totalReceived: 'Total Received',
    orderCol: 'Order',
    clientCol: 'Client',
    stageCol: 'Stage',
    daysCol: 'Days',
    reviewCol: 'Reviews',
    invoiceCol: 'Invoice',
    paidCol: 'Paid',
    balanceCol: 'Balance',
    createdCol: 'Created',
    noOrders: 'No orders yet. Click "+ New Order" to start!',
    confirmDelete: 'Are you sure you want to delete this order?',
    deleteConfirmMsg: 'Are you sure? This cannot be undone.',
    deleteConfirmYes: 'Yes, Delete',
    movedTo: 'Moved to',
    created: 'Order created',
    noteAdded: 'Note added',
    enterNote: 'Write a note...',
    clientName: 'Client name...',
    langBtn: 'ğŸ‡²ğŸ‡³ ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»',
    noClients: 'No clients added yet.',
    removeClient: 'Remove',
    reviewCycles: 'Review Cycles',
    revisions: 'revisions',
    revision: 'revision',
    sentBackReview: 'Sent back for revision',
    invoiceTotal: 'Invoice Total',
    totalPaid: 'Total Paid',
    remaining: 'Remaining',
    paidInFull: 'PAID IN FULL',
    addPayment: 'Add Payment',
    paymentDate: 'Date',
    paymentAmount: 'Amount (EUR)',
    paymentNote: 'Note (optional)',
    payments: 'Payments',
    noPayments: 'No payments recorded yet.',
    editDescription: 'Edit Description',
    editInvoice: 'Edit Invoice Amount',
    saveChanges: 'Save',
    descriptionPlaceholder: 'Add a description for this order...',
    editInfo: 'Edit',
    emailInfo: 'ğŸ“§ Email / Source Information',
    receivedFrom: 'Received From (sender)',
    receivedDate: 'Date Received',
    emailSubject: 'Email Subject / Title',
    filesSection: 'ğŸ“ Drawing Files',
    filePath: 'File Location / Folder Path',
    attachment1: 'Attachment 1',
    attachment2: 'Attachment 2',
    attachment3: 'Attachment 3',
    drawingInfo: 'Drawing Receipt Info',
    sender: 'Sender',
    emailTitle: 'Email Title',
    fileLocation: 'File Location',
    attachments: 'Attachments',
    noAttachments: 'No attachments',
    editDrawingInfo: 'Edit',
    addDrawingVersion: '+ Add Drawing Version',
    drawingVersion: 'V',
    noDrawings: 'No drawing receipts yet. Click "+ Add Drawing Version" to add one.',
    stage1Info: 'ğŸ“¥ Stage 1: Drawing Received',
    stage2Info: 'ğŸ” Stage 2: Review & Correction',
    stage3Info: 'ğŸ“¤ Stage 3: Sent to Client',
    stage4Info: 'âœ… Stage 4: Client Approved',
    stage5Info: 'ğŸ‡©ğŸ‡ª Stage 5: Sent to DE/GE',
    stage6Info: 'ğŸ“Š Stage 6: Calculation Received',
    stage7Info: 'ğŸ‡²ğŸ‡³ Stage 7: Forwarded to MN Client',
    abroadDate: 'Date Sent',
    abroadTo: 'Sent To',
    abroadEmailSubject: 'Email Subject',
    calcDate: 'Date Received',
    calcFrom: 'Received From',
    forwardDate: 'Date Forwarded',
    forwardTo: 'Forwarded To',
    forwardEmailSubject: 'Email Subject',
    driveLink: 'Google Drive Link',
    driveLinkPlaceholder: 'Paste Google Drive shareable link here...',
    openInDrive: 'ğŸ“‚ Open in Drive',
    noDriveLink: 'No link saved',
    reviewDate: 'Review Completed Date',
    reviewSummary: 'Correction Notes',
    reviewSummaryPlaceholder: 'Any additional notes about the corrections...',
    reviewDuration: 'Duration (days worked)',
    reviewDurationPlaceholder: 'e.g. 2.5',
    reviewProducts: 'Schueco Products',
    addProduct: '+ Add Product Line',
    noProducts: 'No products added yet. Click "+ Add Product Line".',
    productCategory: 'Category',
    productSystem: 'System Name',
    productSystemPlaceholder: 'e.g. AWS 75.SI+',
    productM2: 'mÂ²',
    productColor: 'Color (RAL)',
    productColorPlaceholder: 'e.g. RAL 7040 Anthracite',
    productFinish: 'Finish',
    finishNormal: 'Normal RAL',
    finishFine: 'Fine Structure',
    catWindow: 'Window',
    catDoor: 'Door',
    catFacade: 'Facade',
    catInterior: 'Interior Wall',
    catSliding: 'Sliding Door',
    sentDate: 'Date Sent to Client',
    sentEmailSubject: 'Email Subject (sent to client)',
    approvedDate: 'Client Approval Date',
    approvedEmailSubject: 'Email Subject (approval from client)',
    invoicesSection: 'Invoices',
    addInvoice: 'Add Invoice',
    invoiceAmount2: 'Amount (EUR)',
    invoiceDate: 'Invoice Date',
    invoiceNote: 'Description / Note',
    invoiceNotePlaceholder: 'What this invoice covers...',
    noInvoices: 'No invoices yet. Click "+ Add Invoice" to add one.'
  },
  mn: {
    title: 'ğŸ“Š Ğ‘Ğ¾Ñ€Ğ»ÑƒÑƒĞ»Ğ°Ğ»Ñ‚Ñ‹Ğ½ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ñ‹Ğ½ Ñ…ÑĞ½Ğ°Ğ»Ñ‚',
    newOrder: '+ Ğ¨Ğ¸Ğ½Ñ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ°',
    clients: 'ğŸ‘¥ Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ´',
    search: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ° Ñ…Ğ°Ğ¹Ñ…...',
    allClients: 'Ğ‘Ò¯Ñ… Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡',
    allStages: 'Ğ‘Ò¯Ñ… ÑˆĞ°Ñ‚',
    allYears: 'Ğ‘Ò¯Ñ… Ğ¶Ğ¸Ğ»',
    year: 'Ğ–Ğ¸Ğ»',
    orderType: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ñ‹Ğ½ Ñ‚Ó©Ñ€Ó©Ğ»',
    typeDrawing: 'Ğ—ÑƒÑ€Ğ°Ğ³',
    typeMaterial: 'ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹Ğ½ Ğ¶Ğ°Ğ³ÑĞ°Ğ°Ğ»Ñ‚',
    typeLicense: 'Ğ›Ğ¸Ñ†ĞµĞ½Ğ·',
    typeCol: 'Ğ¢Ó©Ñ€Ó©Ğ»',
    tableView: 'ğŸ“‹ Ğ¥Ò¯ÑĞ½ÑĞ³Ñ‚',
    boardView: 'ğŸ“Š Ğ¡Ğ°Ğ¼Ğ±Ğ°Ñ€',
    export: 'ğŸ’¾ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚',
    import: 'ğŸ“‚ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚',
    orderName: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ° / Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ğ½ÑÑ€',
    client: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡',
    description: 'Ğ¢Ğ°Ğ¹Ğ»Ğ±Ğ°Ñ€',
    invoiceAmount: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»Ğ¸Ğ¹Ğ½ Ğ´Ò¯Ğ½ (EUR)',
    cancel: 'Ğ¦ÑƒÑ†Ğ»Ğ°Ñ…',
    save: 'Ğ¥Ğ°Ğ´Ğ³Ğ°Ğ»Ğ°Ñ…',
    manageClients: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ´Ñ‹Ğ½ Ğ¶Ğ°Ğ³ÑĞ°Ğ°Ğ»Ñ‚',
    addClient: 'ĞÑĞ¼ÑÑ…',
    newOrderTitle: 'Ğ¨Ğ¸Ğ½Ñ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ°',
    nextStage: 'Ğ”Ğ°Ñ€Ğ°Ğ°Ğ³Ğ¸Ğ¹Ğ½ ÑˆĞ°Ñ‚ â¡ï¸',
    prevStage: 'â¬…ï¸ Ó¨Ğ¼Ğ½Ó©Ñ…',
    sendBackReview: 'ğŸ”„ Ğ—Ğ°ÑĞ²Ğ°Ñ€ Ñ€ÑƒÑƒ Ğ±ÑƒÑ†Ğ°Ğ°Ñ…',
    deleteOrder: 'ğŸ—‘ï¸ Ğ£ÑÑ‚Ğ³Ğ°Ñ…',
    addNote: 'Ğ¢ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ» Ğ½ÑĞ¼ÑÑ…',
    notes: 'Ğ¢ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ»Ò¯Ò¯Ğ´',
    history: 'Ğ¢Ò¯Ò¯Ñ…',
    finance: 'Ğ¡Ğ°Ğ½Ñ…Ò¯Ò¯',
    info: 'ĞœÑĞ´ÑÑĞ»ÑĞ»',
    stage: 'ĞĞ´Ğ¾Ğ¾Ğ³Ğ¸Ğ¹Ğ½ ÑˆĞ°Ñ‚',
    daysHere: 'Ó©Ğ´Ó©Ñ€ Ğ±Ğ¾Ğ»ÑĞ¾Ğ½',
    day: 'Ó©Ğ´Ó©Ñ€',
    days: 'Ó©Ğ´Ó©Ñ€',
    totalOrders: 'ĞĞ¸Ğ¹Ñ‚ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ°',
    activeOrders: 'Ğ˜Ğ´ÑĞ²Ñ…Ñ‚ÑĞ¹',
    stuckOrders: 'Ğ¡Ğ°Ğ°Ñ‚ÑĞ°Ğ½ (7+ Ó©Ğ´Ó©Ñ€)',
    completedOrders: 'Ğ”ÑƒÑƒÑÑĞ°Ğ½',
    totalInvoiced: 'ĞĞ¸Ğ¹Ñ‚ Ğ½ÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»',
    totalReceived: 'ĞĞ¸Ğ¹Ñ‚ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½',
    orderCol: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ°',
    clientCol: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡',
    stageCol: 'Ğ¨Ğ°Ñ‚',
    daysCol: 'Ó¨Ğ´Ó©Ñ€',
    reviewCol: 'Ğ¥ÑĞ½Ğ°Ñ…',
    invoiceCol: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»',
    paidCol: 'Ğ¢Ó©Ğ»ÑÓ©Ğ½',
    balanceCol: 'Ò®Ğ»Ğ´ÑĞ³Ğ´ÑĞ»',
    createdCol: 'Ò®Ò¯ÑĞ³ÑÑÑĞ½',
    noOrders: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ° Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹. "+ Ğ¨Ğ¸Ğ½Ñ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ°" Ğ´Ğ°Ñ€Ğ½Ğ° ÑƒÑƒ!',
    confirmDelete: 'Ğ­Ğ½Ñ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ñ‹Ğ³ ÑƒÑÑ‚Ğ³Ğ°Ñ… ÑƒÑƒ?',
    deleteConfirmMsg: 'Ğ˜Ñ‚Ğ³ÑĞ»Ñ‚ÑĞ¹ Ğ±Ğ°Ğ¹Ğ½Ğ° ÑƒÑƒ? Ğ­Ğ½Ñ Ò¯Ğ¹Ğ»Ğ´Ğ»Ğ¸Ğ¹Ğ³ Ğ±ÑƒÑ†Ğ°Ğ°Ñ… Ğ±Ğ¾Ğ»Ğ¾Ğ¼Ğ¶Ğ³Ò¯Ğ¹.',
    deleteConfirmYes: 'Ğ¢Ğ¸Ğ¹Ğ¼, Ğ£ÑÑ‚Ğ³Ğ°Ñ…',
    movedTo: 'Ğ¨Ğ¸Ğ»Ğ¶Ò¯Ò¯Ğ»ÑÑĞ½:',
    created: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ° Ò¯Ò¯ÑĞ³ÑÑÑĞ½',
    noteAdded: 'Ğ¢ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ» Ğ½ÑĞ¼ÑÑĞ½',
    enterNote: 'Ğ¢ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ» Ğ±Ğ¸Ñ‡Ğ¸Ñ…...',
    clientName: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ¹Ğ½ Ğ½ÑÑ€...',
    langBtn: 'ğŸ‡¬ğŸ‡§ English',
    noClients: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡ Ğ½ÑĞ¼ÑÑĞ³Ò¯Ğ¹ Ğ±Ğ°Ğ¹Ğ½Ğ°.',
    removeClient: 'Ğ¥Ğ°ÑĞ°Ñ…',
    reviewCycles: 'Ğ¥ÑĞ½Ğ°Ñ… Ñ‚Ğ¾Ğ¹Ñ€Ğ¾Ğ³',
    revisions: 'Ğ·Ğ°ÑĞ²Ğ°Ñ€',
    revision: 'Ğ·Ğ°ÑĞ²Ğ°Ñ€',
    sentBackReview: 'Ğ—Ğ°ÑĞ²Ğ°Ñ€ Ñ€ÑƒÑƒ Ğ±ÑƒÑ†Ğ°Ğ°ÑĞ°Ğ½',
    invoiceTotal: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»Ğ¸Ğ¹Ğ½ Ğ´Ò¯Ğ½',
    totalPaid: 'ĞĞ¸Ğ¹Ñ‚ Ñ‚Ó©Ğ»ÑÓ©Ğ½',
    remaining: 'Ò®Ğ»Ğ´ÑĞ³Ğ´ÑĞ»',
    paidInFull: 'Ğ‘Ò®Ğ Ğ­Ğ Ğ¢Ó¨Ğ›Ğ¡Ó¨Ğ',
    addPayment: 'Ğ¢Ó©Ğ»Ğ±Ó©Ñ€ Ğ½ÑĞ¼ÑÑ…',
    paymentDate: 'ĞĞ³Ğ½Ğ¾Ğ¾',
    paymentAmount: 'Ğ”Ò¯Ğ½ (EUR)',
    paymentNote: 'Ğ¢ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ» (ÑĞ¾Ğ½Ğ³Ğ¾Ğ»Ñ‚Ğ¾Ğ¾Ñ€)',
    payments: 'Ğ¢Ó©Ğ»Ğ±Ó©Ñ€Ò¯Ò¯Ğ´',
    noPayments: 'Ğ¢Ó©Ğ»Ğ±Ó©Ñ€ Ğ±Ò¯Ñ€Ñ‚Ğ³ÑĞ³Ğ´ÑÑĞ³Ò¯Ğ¹ Ğ±Ğ°Ğ¹Ğ½Ğ°.',
    editDescription: 'Ğ¢Ğ°Ğ¹Ğ»Ğ±Ğ°Ñ€ Ğ·Ğ°ÑĞ°Ñ…',
    editInvoice: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»Ğ¸Ğ¹Ğ½ Ğ´Ò¯Ğ½ Ğ·Ğ°ÑĞ°Ñ…',
    saveChanges: 'Ğ¥Ğ°Ğ´Ğ³Ğ°Ğ»Ğ°Ñ…',
    descriptionPlaceholder: 'Ğ­Ğ½Ñ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ñ‹Ğ½ Ñ‚Ğ°Ğ¹Ğ»Ğ±Ğ°Ñ€ Ğ½ÑĞ¼ÑÑ…...',
    editInfo: 'Ğ—Ğ°ÑĞ°Ñ…',
    emailInfo: 'ğŸ“§ Ğ˜Ğ¼ÑĞ¹Ğ» / Ğ­Ñ… ÑÑƒÑ€Ğ²Ğ°Ğ»Ğ¶ Ğ¼ÑĞ´ÑÑĞ»ÑĞ»',
    receivedFrom: 'Ğ¥ÑĞ½ÑÑÑ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½',
    receivedDate: 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    emailSubject: 'Ğ˜Ğ¼ÑĞ¹Ğ»Ğ¸Ğ¹Ğ½ Ğ³Ğ°Ñ€Ñ‡Ğ¸Ğ³',
    filesSection: 'ğŸ“ Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ñ„Ğ°Ğ¹Ğ»ÑƒÑƒĞ´',
    filePath: 'Ğ¤Ğ°Ğ¹Ğ»Ñ‹Ğ½ Ğ±Ğ°Ğ¹Ñ€ÑˆĞ¸Ğ» / Ğ¥Ğ°Ğ²Ñ‚Ğ°ÑĞ½Ñ‹ Ğ·Ğ°Ğ¼',
    attachment1: 'Ğ¥Ğ°Ğ²ÑÑ€Ğ°Ğ»Ñ‚ 1',
    attachment2: 'Ğ¥Ğ°Ğ²ÑÑ€Ğ°Ğ»Ñ‚ 2',
    attachment3: 'Ğ¥Ğ°Ğ²ÑÑ€Ğ°Ğ»Ñ‚ 3',
    drawingInfo: 'Ğ—ÑƒÑ€Ğ°Ğ³ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½ Ğ¼ÑĞ´ÑÑĞ»ÑĞ»',
    sender: 'Ğ˜Ğ»Ğ³ÑÑĞ³Ñ‡',
    emailTitle: 'Ğ˜Ğ¼ÑĞ¹Ğ»Ğ¸Ğ¹Ğ½ Ğ³Ğ°Ñ€Ñ‡Ğ¸Ğ³',
    fileLocation: 'Ğ¤Ğ°Ğ¹Ğ»Ñ‹Ğ½ Ğ±Ğ°Ğ¹Ñ€ÑˆĞ¸Ğ»',
    attachments: 'Ğ¥Ğ°Ğ²ÑÑ€Ğ°Ğ»Ñ‚ÑƒÑƒĞ´',
    noAttachments: 'Ğ¥Ğ°Ğ²ÑÑ€Ğ°Ğ»Ñ‚ Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹',
    editDrawingInfo: 'Ğ—Ğ°ÑĞ°Ñ…',
    addDrawingVersion: '+ Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ñ…ÑƒĞ²Ğ¸Ğ»Ğ±Ğ°Ñ€ Ğ½ÑĞ¼ÑÑ…',
    drawingVersion: 'V',
    noDrawings: 'Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ñ…Ò¯Ğ»ÑÑĞ»Ñ‚ Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹. "+ Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ñ…ÑƒĞ²Ğ¸Ğ»Ğ±Ğ°Ñ€ Ğ½ÑĞ¼ÑÑ…" Ğ´Ğ°Ñ€Ğ½Ğ° ÑƒÑƒ.',
    stage1Info: 'ğŸ“¥ 1-Ñ€ ÑˆĞ°Ñ‚: Ğ—ÑƒÑ€Ğ°Ğ³ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½',
    stage2Info: 'ğŸ” 2-Ñ€ ÑˆĞ°Ñ‚: Ğ¥ÑĞ½Ğ°Ñ… & Ğ—Ğ°ÑĞ°Ñ…',
    stage3Info: 'ğŸ“¤ 3-Ñ€ ÑˆĞ°Ñ‚: Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ´ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½',
    stage4Info: 'âœ… 4-Ñ€ ÑˆĞ°Ñ‚: Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡ Ğ·Ó©Ğ²ÑˆÓ©Ó©Ñ€ÑÓ©Ğ½',
    stage5Info: 'ğŸ‡©ğŸ‡ª 5-Ñ€ ÑˆĞ°Ñ‚: Ğ“ĞµÑ€Ğ¼Ğ°Ğ½/Ğ“Ò¯Ñ€Ğ¶ Ñ€ÑƒÑƒ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½',
    stage6Info: 'ğŸ“Š 6-Ñ€ ÑˆĞ°Ñ‚: Ğ¢Ğ¾Ğ¾Ñ†Ğ¾Ğ¾ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½',
    stage7Info: 'ğŸ‡²ğŸ‡³ 7-Ñ€ ÑˆĞ°Ñ‚: ĞœĞ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ´ Ğ´Ğ°Ğ¼Ğ¶ÑƒÑƒĞ»ÑĞ°Ğ½',
    abroadDate: 'Ğ˜Ğ»Ğ³ÑÑÑÑĞ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    abroadTo: 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²Ğ°Ğ³Ñ‡',
    abroadEmailSubject: 'Ğ˜Ğ¼ÑĞ¹Ğ»Ğ¸Ğ¹Ğ½ Ğ³Ğ°Ñ€Ñ‡Ğ¸Ğ³',
    calcDate: 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    calcFrom: 'Ğ˜Ğ»Ğ³ÑÑĞ³Ñ‡',
    forwardDate: 'Ğ”Ğ°Ğ¼Ğ¶ÑƒÑƒĞ»ÑĞ°Ğ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    forwardTo: 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²Ğ°Ğ³Ñ‡',
    forwardEmailSubject: 'Ğ˜Ğ¼ÑĞ¹Ğ»Ğ¸Ğ¹Ğ½ Ğ³Ğ°Ñ€Ñ‡Ğ¸Ğ³',
    driveLink: 'Google Drive Ñ…Ğ¾Ğ»Ğ±Ğ¾Ğ¾Ñ',
    driveLinkPlaceholder: 'Google Drive-Ñ‹Ğ½ Ñ…ÑƒĞ²Ğ°Ğ°Ğ»Ñ†Ğ°Ñ… Ñ…Ğ¾Ğ»Ğ±Ğ¾Ğ¾ÑÑ‹Ğ³ ÑĞ½Ğ´ Ğ±ÑƒÑƒĞ»Ğ³Ğ°Ğ½Ğ° ÑƒÑƒ...',
    openInDrive: 'ğŸ“‚ Drive-Ğ´ Ğ½ÑÑÑ…',
    noDriveLink: 'Ğ¥Ğ¾Ğ»Ğ±Ğ¾Ğ¾Ñ Ñ…Ğ°Ğ´Ğ³Ğ°Ğ»Ğ°Ğ°Ğ³Ò¯Ğ¹',
    reviewDate: 'Ğ¥ÑĞ½Ğ°ÑĞ°Ğ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    reviewSummary: 'Ğ—Ğ°ÑĞ²Ğ°Ñ€Ñ‹Ğ½ Ñ‚ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ»',
    reviewSummaryPlaceholder: 'ĞÑĞ¼ÑĞ»Ñ‚ Ñ‚ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ»...',
    reviewDuration: 'Ğ¥ÑƒĞ³Ğ°Ñ†Ğ°Ğ° (Ğ°Ğ¶Ğ¸Ğ»Ğ»Ğ°ÑĞ°Ğ½ Ó©Ğ´Ó©Ñ€)',
    reviewDurationPlaceholder: 'Ğ¶Ğ¸ÑˆÑÑ: 2.5',
    reviewProducts: 'Schueco Ğ±Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½',
    addProduct: '+ Ğ‘Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½ Ğ½ÑĞ¼ÑÑ…',
    noProducts: 'Ğ‘Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½ Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹. "+ Ğ‘Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½ Ğ½ÑĞ¼ÑÑ…" Ğ´Ğ°Ñ€Ğ½Ğ° ÑƒÑƒ.',
    productCategory: 'Ğ¢Ó©Ñ€Ó©Ğ»',
    productSystem: 'Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ¸Ğ¹Ğ½ Ğ½ÑÑ€',
    productSystemPlaceholder: 'Ğ¶Ğ¸ÑˆÑÑ: AWS 75.SI+',
    productM2: 'Ğ¼Â²',
    productColor: 'Ó¨Ğ½Ğ³Ó© (RAL)',
    productColorPlaceholder: 'Ğ¶Ğ¸ÑˆÑÑ: RAL 7040 ĞĞ½Ñ‚Ñ€Ğ°Ñ†Ğ¸Ñ‚',
    productFinish: 'Ğ“Ğ°Ğ´Ğ°Ñ€Ğ³ÑƒÑƒ',
    finishNormal: 'Ğ­Ğ½Ğ³Ğ¸Ğ¹Ğ½ RAL',
    finishFine: 'ĞĞ°Ñ€Ğ¸Ğ¹Ğ½ Ğ±Ò¯Ñ‚ÑÑ†',
    catWindow: 'Ğ¦Ğ¾Ğ½Ñ…',
    catDoor: 'Ğ¥Ğ°Ğ°Ğ»Ğ³Ğ°',
    catFacade: 'Ğ¤Ğ°ÑĞ°Ğ´',
    catInterior: 'Ğ”Ğ¾Ñ‚Ğ¾Ñ€ ÑˆĞ¸Ğ»ÑĞ½ Ñ…Ğ°Ğ½Ğ°',
    catSliding: 'Ğ“Ò¯Ğ¹Ğ´ÑĞ³ Ñ…Ğ°Ğ°Ğ»Ğ³Ğ°',
    sentDate: 'Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ´ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    sentEmailSubject: 'Ğ˜Ğ¼ÑĞ¹Ğ»Ğ¸Ğ¹Ğ½ Ğ³Ğ°Ñ€Ñ‡Ğ¸Ğ³ (Ğ¸Ğ»Ğ³ÑÑÑÑĞ½)',
    approvedDate: 'Ğ—Ó©Ğ²ÑˆÓ©Ó©Ñ€ÑÓ©Ğ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    approvedEmailSubject: 'Ğ˜Ğ¼ÑĞ¹Ğ»Ğ¸Ğ¹Ğ½ Ğ³Ğ°Ñ€Ñ‡Ğ¸Ğ³ (Ğ·Ó©Ğ²ÑˆÓ©Ó©Ñ€Ğ»Ğ¸Ğ¹Ğ½)',
    invoicesSection: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»Ò¯Ò¯Ğ´',
    addInvoice: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ» Ğ½ÑĞ¼ÑÑ…',
    invoiceAmount2: 'Ğ”Ò¯Ğ½ (EUR)',
    invoiceDate: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ»Ğ¸Ğ¹Ğ½ Ğ¾Ğ³Ğ½Ğ¾Ğ¾',
    invoiceNote: 'Ğ¢Ğ°Ğ¹Ğ»Ğ±Ğ°Ñ€ / Ğ¢ÑĞ¼Ğ´ÑĞ³Ğ»ÑĞ»',
    invoiceNotePlaceholder: 'Ğ­Ğ½Ñ Ğ½ÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ» ÑÑƒĞ³ Ñ…Ğ°Ğ¼Ğ°Ñ€Ñ‡ Ğ±Ğ°Ğ¹Ğ³Ğ°Ğ°...',
    noInvoices: 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ» Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹. "+ ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ» Ğ½ÑĞ¼ÑÑ…" Ğ´Ğ°Ñ€Ğ½Ğ° ÑƒÑƒ.'
  },
  ka: {
    title: 'ğŸ“Š áƒ’áƒáƒ§áƒ˜áƒ“áƒ•áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ”áƒ‘áƒ˜áƒ¡ áƒ¢áƒ áƒ”áƒ™áƒ”áƒ áƒ˜',
    newOrder: '+ áƒáƒ®áƒáƒšáƒ˜ áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ',
    clients: 'ğŸ‘¥ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜',
    search: 'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ˜áƒ¡ áƒ«áƒ˜áƒ”áƒ‘áƒ...',
    allClients: 'áƒ§áƒ•áƒ”áƒšáƒ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜',
    allStages: 'áƒ§áƒ•áƒ”áƒšáƒ áƒ”áƒ¢áƒáƒáƒ˜',
    allYears: 'áƒ§áƒ•áƒ”áƒšáƒ áƒ¬áƒ”áƒšáƒ˜',
    year: 'áƒ¬áƒ”áƒšáƒ˜',
    orderType: 'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜',
    typeDrawing: 'áƒœáƒáƒ®áƒáƒ–áƒ˜',
    typeMaterial: 'áƒ›áƒáƒ¡áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ˜áƒ',
    typeLicense: 'áƒšáƒ˜áƒªáƒ”áƒœáƒ–áƒ˜áƒ',
    typeCol: 'áƒ¢áƒ˜áƒáƒ˜',
    tableView: 'ğŸ“‹ áƒªáƒ®áƒ áƒ˜áƒšáƒ˜áƒ¡ áƒ®áƒ”áƒ“áƒ˜',
    boardView: 'ğŸ“Š áƒ“áƒáƒ¤áƒ˜áƒ¡ áƒ®áƒ”áƒ“áƒ˜',
    export: 'ğŸ’¾ áƒ”áƒ¥áƒ¡áƒáƒáƒ áƒ¢áƒ˜',
    import: 'ğŸ“‚ áƒ˜áƒ›áƒáƒáƒ áƒ¢áƒ˜',
    orderName: 'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ / áƒœáƒáƒ®áƒáƒ–áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜',
    client: 'áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜',
    description: 'áƒáƒ¦áƒ¬áƒ”áƒ áƒ',
    invoiceAmount: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜áƒ¡ áƒ—áƒáƒœáƒ®áƒ (EUR)',
    cancel: 'áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ',
    save: 'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ',
    manageClients: 'áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ',
    addClient: 'áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ',
    newOrderTitle: 'áƒáƒ®áƒáƒšáƒ˜ áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ',
    nextStage: 'áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’áƒ˜ áƒ”áƒ¢áƒáƒáƒ˜ â¡ï¸',
    prevStage: 'â¬…ï¸ áƒ¬áƒ˜áƒœáƒ',
    sendBackReview: 'ğŸ”„ áƒ’áƒáƒ“áƒáƒ’áƒ–áƒáƒ•áƒœáƒ áƒ’áƒáƒ“áƒáƒ¡áƒ˜áƒœáƒ¯áƒ•áƒáƒ–áƒ”',
    deleteOrder: 'ğŸ—‘ï¸ áƒ¬áƒáƒ¨áƒšáƒ',
    addNote: 'áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ',
    notes: 'áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ”áƒ‘áƒ˜',
    history: 'áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ',
    finance: 'áƒ¤áƒ˜áƒœáƒáƒœáƒ¡áƒ”áƒ‘áƒ˜',
    info: 'áƒ˜áƒœáƒ¤áƒ',
    stage: 'áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ” áƒ”áƒ¢áƒáƒáƒ˜',
    daysHere: 'áƒ“áƒ¦áƒ” áƒáƒ¥',
    day: 'áƒ“áƒ¦áƒ”',
    days: 'áƒ“áƒ¦áƒ”',
    totalOrders: 'áƒ¡áƒ£áƒš áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ”áƒ‘áƒ˜',
    activeOrders: 'áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜',
    stuckOrders: 'áƒ’áƒáƒ©áƒ”áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ (7+ áƒ“áƒ¦áƒ”)',
    completedOrders: 'áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜',
    totalInvoiced: 'áƒ¡áƒ£áƒš áƒ’áƒáƒ›áƒáƒ¬áƒ”áƒ áƒ˜áƒšáƒ˜',
    totalReceived: 'áƒ¡áƒ£áƒš áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜',
    orderCol: 'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ',
    clientCol: 'áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜',
    stageCol: 'áƒ”áƒ¢áƒáƒáƒ˜',
    daysCol: 'áƒ“áƒ¦áƒ”áƒ”áƒ‘áƒ˜',
    reviewCol: 'áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ”áƒ‘áƒ˜',
    invoiceCol: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜',
    paidCol: 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜',
    balanceCol: 'áƒœáƒáƒ¨áƒ—áƒ˜',
    createdCol: 'áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒšáƒ˜áƒ',
    noOrders: 'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
    confirmDelete: 'áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ?',
    deleteConfirmMsg: 'áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ ? áƒ”áƒ¡ áƒ›áƒáƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ áƒ¨áƒ”áƒ£áƒ¥áƒªáƒ”áƒ•áƒáƒ“áƒ˜áƒ.',
    deleteConfirmYes: 'áƒ“áƒ˜áƒáƒ®, áƒ¬áƒáƒ•áƒ¨áƒáƒšáƒ',
    movedTo: 'áƒ’áƒáƒ“áƒáƒ˜áƒ¢áƒáƒœáƒ',
    created: 'áƒ¨áƒ”áƒ˜áƒ¥áƒ›áƒœáƒ',
    noteAdded: 'áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ',
    enterNote: 'áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ...',
    clientName: 'áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜',
    langBtn: 'áƒ”áƒœáƒ',
    noClients: 'áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
    removeClient: 'áƒ¬áƒáƒ¨áƒšáƒ',
    reviewCycles: 'áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ˜áƒ¡ áƒªáƒ˜áƒ™áƒšáƒ”áƒ‘áƒ˜',
    revisions: 'áƒ’áƒáƒ“áƒáƒ¡áƒ˜áƒœáƒ¯áƒ•áƒ”áƒ‘áƒ˜',
    revision: 'áƒ’áƒáƒ“áƒáƒ¡áƒ˜áƒœáƒ¯áƒ•áƒ',
    sentBackReview: 'áƒ’áƒáƒ“áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ áƒ’áƒáƒ“áƒáƒ¡áƒ˜áƒœáƒ¯áƒ•áƒáƒ–áƒ”',
    invoiceTotal: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜áƒ¡ áƒ¯áƒáƒ›áƒ˜',
    totalPaid: 'áƒ¡áƒ£áƒš áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜',
    remaining: 'áƒ“áƒáƒ áƒ©áƒ”áƒœáƒ˜áƒšáƒ˜',
    paidInFull: 'áƒ¡áƒ áƒ£áƒšáƒáƒ“ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜',
    addPayment: 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ',
    paymentDate: 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    paymentAmount: 'áƒ—áƒáƒœáƒ®áƒ',
    paymentNote: 'áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ',
    payments: 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜',
    noPayments: 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
    editDescription: 'áƒáƒ¦áƒ¬áƒ”áƒ áƒ˜áƒ¡ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ',
    editInvoice: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜áƒ¡ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ',
    saveChanges: 'áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ',
    descriptionPlaceholder: 'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ˜áƒ¡ áƒáƒ¦áƒ¬áƒ”áƒ áƒ...',
    editInfo: 'áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ',
    emailInfo: 'ğŸ“§ áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ / áƒ¬áƒ§áƒáƒ áƒáƒ¡ áƒ˜áƒœáƒ¤áƒ',
    receivedFrom: 'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜ (áƒ’áƒáƒ›áƒáƒ›áƒ’áƒ–áƒáƒ•áƒœáƒ˜)',
    receivedDate: 'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    emailSubject: 'áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜',
    filesSection: 'ğŸ“ áƒœáƒáƒ®áƒáƒ–áƒ˜áƒ¡ áƒ¤áƒáƒ˜áƒšáƒ”áƒ‘áƒ˜',
    filePath: 'áƒ¤áƒáƒ˜áƒšáƒ˜áƒ¡ áƒ›áƒ“áƒ”áƒ‘áƒáƒ áƒ”áƒáƒ‘áƒ',
    attachment1: 'áƒ“áƒáƒœáƒáƒ áƒ—áƒ˜ 1',
    attachment2: 'áƒ“áƒáƒœáƒáƒ áƒ—áƒ˜ 2',
    attachment3: 'áƒ“áƒáƒœáƒáƒ áƒ—áƒ˜ 3',
    drawingInfo: 'áƒœáƒáƒ®áƒáƒ–áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒœáƒ¤áƒ',
    sender: 'áƒ’áƒáƒ›áƒáƒ›áƒ’áƒ–áƒáƒ•áƒœáƒ˜',
    emailTitle: 'áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜',
    fileLocation: 'áƒ¤áƒáƒ˜áƒšáƒ˜áƒ¡ áƒ›áƒ“áƒ”áƒ‘áƒáƒ áƒ”áƒáƒ‘áƒ',
    attachments: 'áƒ“áƒáƒœáƒáƒ áƒ—áƒ”áƒ‘áƒ˜',
    noAttachments: 'áƒ“áƒáƒœáƒáƒ áƒ—áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
    editDrawingInfo: 'áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ',
    addDrawingVersion: '+ áƒœáƒáƒ®áƒáƒ–áƒ˜áƒ¡ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ',
    drawingVersion: 'áƒ•áƒ”áƒ áƒ¡.',
    noDrawings: 'áƒœáƒáƒ®áƒáƒ–áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡. "+ áƒœáƒáƒ®áƒáƒ–áƒ˜áƒ¡ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ" áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ”áƒ—.',
    stage1Info: 'ğŸ“¥ áƒ”áƒ¢áƒáƒáƒ˜ 1: áƒœáƒáƒ®áƒáƒ–áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ',
    stage2Info: 'ğŸ” áƒ”áƒ¢áƒáƒáƒ˜ 2: áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ & áƒ™áƒáƒ áƒ”áƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ',
    stage3Info: 'ğŸ“¤ áƒ”áƒ¢áƒáƒáƒ˜ 3: áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ—áƒáƒœ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ',
    stage4Info: 'âœ… áƒ”áƒ¢áƒáƒáƒ˜ 4: áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜áƒ¡ áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ”áƒ‘áƒ',
    stage5Info: 'ğŸ‡©ğŸ‡ª áƒ”áƒ¢áƒáƒáƒ˜ 5: áƒ’áƒ”áƒ áƒ›/áƒ¡áƒáƒ¥-áƒ¨áƒ˜ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ',
    stage6Info: 'ğŸ“Š áƒ”áƒ¢áƒáƒáƒ˜ 6: áƒ™áƒáƒšáƒ™áƒ£áƒšáƒáƒªáƒ˜áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ',
    stage7Info: 'ğŸ‡²ğŸ‡³ áƒ”áƒ¢áƒáƒáƒ˜ 7: MN-áƒ–áƒ” áƒ’áƒáƒ“áƒáƒ’áƒ–áƒáƒ•áƒœáƒ',
    abroadDate: 'áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜ (áƒ¡áƒáƒ–áƒ¦áƒ•áƒáƒ áƒ’áƒáƒ áƒ”áƒ—)',
    abroadTo: 'áƒ•áƒ˜áƒ¡',
    abroadEmailSubject: 'áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜ (áƒ¡áƒáƒ–áƒ¦áƒ•áƒáƒ áƒ’áƒáƒ áƒ”áƒ—)',
    calcDate: 'áƒ™áƒáƒšáƒ™áƒ£áƒšáƒáƒªáƒ˜áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    calcFrom: 'áƒ•áƒ˜áƒ¡áƒ’áƒáƒœ',
    forwardDate: 'áƒ’áƒáƒ“áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    forwardTo: 'áƒ•áƒ˜áƒ¡',
    forwardEmailSubject: 'áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜ (áƒ’áƒáƒ“áƒáƒ’áƒ–áƒáƒ•áƒœáƒ)',
    driveLink: 'Drive áƒ‘áƒ›áƒ£áƒšáƒ˜',
    driveLinkPlaceholder: 'https://drive.google.com/...',
    openInDrive: 'ğŸ“‚ Drive-áƒ¨áƒ˜ áƒ’áƒáƒ®áƒ¡áƒœáƒ',
    noDriveLink: 'áƒ‘áƒ›áƒ£áƒšáƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
    reviewDate: 'áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    reviewSummary: 'áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ˜áƒ¡ áƒ¨áƒ”áƒ¯áƒáƒ›áƒ”áƒ‘áƒ',
    reviewSummaryPlaceholder: 'áƒ áƒ áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ£áƒšáƒ˜áƒ...',
    reviewDuration: 'áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ˜áƒ¡ áƒ®áƒáƒœáƒ’áƒ áƒ«áƒšáƒ˜áƒ•áƒáƒ‘áƒ',
    reviewDurationPlaceholder: 'áƒ›áƒáƒ’. 3 áƒ“áƒ¦áƒ”',
    reviewProducts: 'áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ”áƒ‘áƒ˜',
    addProduct: '+ áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ',
    noProducts: 'áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
    productCategory: 'áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ',
    productSystem: 'áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ / áƒ›áƒáƒ“áƒ”áƒšáƒ˜',
    productSystemPlaceholder: 'áƒ›áƒáƒ’. AWS 75.SI',
    productM2: 'áƒ›Â²',
    productColor: 'áƒ¤áƒ”áƒ áƒ˜ (RAL)',
    productColorPlaceholder: 'áƒ›áƒáƒ’. RAL 7016',
    productFinish: 'áƒ–áƒ”áƒ“áƒáƒáƒ˜áƒ áƒ˜',
    finishNormal: 'áƒœáƒáƒ áƒ›. RAL',
    finishFine: 'áƒ¬áƒ•áƒ áƒ˜áƒšáƒ˜ áƒ¡áƒ¢áƒ áƒ£áƒ¥áƒ¢áƒ£áƒ áƒ',
    catWindow: 'áƒ¤áƒáƒœáƒ¯áƒáƒ áƒ',
    catDoor: 'áƒ™áƒáƒ áƒ˜',
    catFacade: 'áƒ¤áƒáƒ¡áƒáƒ“áƒ˜',
    catInterior: 'áƒ¨áƒ˜áƒ“áƒ áƒ›áƒ˜áƒœáƒ˜áƒ¡ áƒ™áƒ”áƒ“áƒ”áƒšáƒ˜',
    catSliding: 'áƒ¡áƒ áƒ˜áƒáƒšáƒ áƒ™áƒáƒ áƒ˜',
    sentDate: 'áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ—áƒáƒœ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    sentEmailSubject: 'áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜ (áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ—áƒáƒœ)',
    approvedDate: 'áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ”áƒ‘áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    approvedEmailSubject: 'áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜ (áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ”áƒ‘áƒ)',
    invoicesSection: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ”áƒ‘áƒ˜',
    addInvoice: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ',
    invoiceAmount2: 'áƒ—áƒáƒœáƒ®áƒ (EUR)',
    invoiceDate: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
    invoiceNote: 'áƒáƒ¦áƒ¬áƒ”áƒ áƒ / áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ',
    invoiceNotePlaceholder: 'áƒ”áƒ¡ áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜ áƒ áƒáƒ¡ áƒ›áƒáƒ˜áƒªáƒáƒ•áƒ¡...',
    noInvoices: 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡. "+ áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ" áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ”áƒ—.'
  }
};

let state = {
  lang: 'en',
  view: 'board',
  clients: [],
  orders: [],
  nextOrderId: 1
};

// ===== PERSISTENCE =====
function migrateOrders(orders) {
  (orders || []).forEach(o => {
    if (o.year === undefined) {
      const firstDate = (o.drawings && o.drawings[0] && o.drawings[0].date) ? o.drawings[0].date : null;
      o.year = firstDate ? new Date(firstDate).getFullYear() : new Date(o.created || Date.now()).getFullYear();
    }
    if (o.orderType === undefined) o.orderType = 'drawing';
    if (o.reviewCycles === undefined) o.reviewCycles = 0;
    if (!o.notes) o.notes = [];        // Firebase drops empty arrays â†’ undefined
    if (!o.history) o.history = [];    // Firebase drops empty arrays â†’ undefined
    if (o.invoiceAmount === undefined) o.invoiceAmount = 0;
    if (o.payments === undefined) o.payments = [];
    if (o.receivedFrom === undefined) o.receivedFrom = '';
    if (o.receivedDate === undefined) o.receivedDate = '';
    if (o.emailSubject === undefined) o.emailSubject = '';
    if (o.filePath === undefined) o.filePath = '';
    if (o.attachments === undefined) o.attachments = [];
    // Stage-specific fields (added for colleague workflow)
    if (o.driveLink === undefined) o.driveLink = '';
    // Drawing versions log: migrate old single fields into drawings[0]
    if (!o.drawings) {
      const hasOld = o.receivedFrom || o.receivedDate || o.emailSubject || o.driveLink;
      o.drawings = hasOld
        ? [{ id: 1, date: o.receivedDate || '', from: o.receivedFrom || '', subject: o.emailSubject || '', driveLink: o.driveLink || '' }]
        : [];
      o.nextDrawingId = o.drawings.length > 0 ? 2 : 1;
    }
    if (o.nextDrawingId === undefined) {
      o.nextDrawingId = o.drawings.length > 0 ? Math.max(...o.drawings.map(d => d.id)) + 1 : 1;
    }
    if (o.reviewDate === undefined) o.reviewDate = '';
    if (o.reviewSummary === undefined) o.reviewSummary = '';
    if (o.reviewDriveLink === undefined) o.reviewDriveLink = '';
    if (o.reviewDuration === undefined) o.reviewDuration = '';
    if (!o.reviewProducts) { o.reviewProducts = []; o.nextProductId = 1; }
    if (o.nextProductId === undefined) {
      o.nextProductId = o.reviewProducts.length > 0 ? Math.max(...o.reviewProducts.map(p => p.id)) + 1 : 1;
    }
    o.reviewProducts.forEach(p => { if (!p.finish) p.finish = 'normal'; }); // migrate: add finish type
    if (o.sentDate === undefined) o.sentDate = '';
    if (o.sentEmailSubject === undefined) o.sentEmailSubject = '';
    if (o.sentDriveLink === undefined) o.sentDriveLink = '';
    if (o.approvedDate === undefined) o.approvedDate = '';
    if (o.approvedEmailSubject === undefined) o.approvedEmailSubject = '';
    if (o.approvedDriveLink === undefined) o.approvedDriveLink = '';
    if (o.abroadDate === undefined) o.abroadDate = '';
    if (o.abroadTo === undefined) o.abroadTo = '';
    if (o.abroadEmailSubject === undefined) o.abroadEmailSubject = '';
    if (o.abroadDriveLink === undefined) o.abroadDriveLink = '';
    if (o.calcDate === undefined) o.calcDate = '';
    if (o.calcFrom === undefined) o.calcFrom = '';
    if (o.calcDriveLink === undefined) o.calcDriveLink = '';
    if (o.forwardDate === undefined) o.forwardDate = '';
    if (o.forwardTo === undefined) o.forwardTo = '';
    if (o.forwardEmailSubject === undefined) o.forwardEmailSubject = '';
    if (o.forwardDriveLink === undefined) o.forwardDriveLink = '';
    if (o.stage5FilledBy === undefined) o.stage5FilledBy = '';
    if (o.stage6FilledBy === undefined) o.stage6FilledBy = '';
    if (o.stage7FilledBy === undefined) o.stage7FilledBy = '';
    // Stage author badges: who filled each step (role: 'admin'=Ts, 'colleague'=Ayush)
    // stageBadgesFixed flag: once set, badges are real saves and must not be overwritten by migration
    if (!o.stageBadgesFixed) {
      // One-time correction: old migration wrongly wrote 'admin'; all existing data was filled by Ayush
      o.stage1FilledBy = (o.drawings && o.drawings.length > 0) ? 'colleague' : '';
      o.stage2FilledBy = ((o.reviewProducts && o.reviewProducts.length > 0) || o.reviewDuration) ? 'colleague' : '';
      o.stage3FilledBy = (o.sentDate || o.sentEmailSubject) ? 'colleague' : '';
      o.stage4FilledBy = (o.approvedDate || o.approvedEmailSubject) ? 'colleague' : '';
      o.stageBadgesFixed = true; // never run this block again for this order
    }
    // Multi-invoice migration: convert old single invoiceAmount to invoices[]
    if (o.invoices === undefined) {
      if (o.invoiceAmount && o.invoiceAmount > 0) {
        o.invoices = [{ id: 1, amount: o.invoiceAmount, date: '', note: '' }];
        o.nextInvoiceId = 2;
      } else {
        o.invoices = [];
        o.nextInvoiceId = 1;
      }
    }
    if (o.nextInvoiceId === undefined) {
      o.nextInvoiceId = (o.invoices.length > 0)
        ? Math.max(...o.invoices.map(i => i.id)) + 1 : 1;
    }
  });
}

function saveState() {
  // Always save to localStorage as backup
  try { localStorage.setItem('salesTracker', JSON.stringify(state)); } catch(e) {}
  // Save to Firebase if connected
  if (firebaseReady && db && !isSaving) {
    isSaving = true;
    db.ref('state').set(state).then(() => {
      isSaving = false;
    }).catch(err => {
      isSaving = false;
      console.warn('Firebase save failed:', err);
    });
  }
}

function loadState() {
  // Load from localStorage first (instant, offline-ready)
  try {
    const d = localStorage.getItem('salesTracker');
    if (d) {
      state = JSON.parse(d);
      migrateOrders(state.orders);
    }
  } catch(e) {}
}

function setupFirebaseSync() {
  if (!firebaseReady || !db) {
    setSyncStatus('offline');
    return;
  }

  setSyncStatus('connecting');

  // Monitor connection status â€” .info/connected fires false first, then true once connected
  let hasConnected = false;
  db.ref('.info/connected').on('value', snap => {
    if (snap.val() === true) {
      hasConnected = true;
      setSyncStatus('online');
    } else if (hasConnected) {
      // Only show offline after we had a connection (not on the initial false)
      setSyncStatus('offline');
    }
  });

  // Listen for real-time changes from Firebase (syncs between users)
  db.ref('state').on('value', snapshot => {
    hasConnected = true;
    setSyncStatus('online');
    if (isSaving) return; // ignore our own writes coming back
    const data = snapshot.val();
    if (data && data.orders) {
      migrateOrders(data.orders);
      state = data;
      try { localStorage.setItem('salesTracker', JSON.stringify(state)); } catch(e) {}
      updateUI();
    }
  }, err => {
    setSyncStatus('error');
  });
}

function setSyncStatus(status) {
  const dot = document.getElementById('syncDot');
  const text = document.getElementById('syncText');
  if (!dot || !text) return;
  if (status === 'online') {
    dot.style.background = '#10b981';
    text.textContent = ls('Synced', 'Ğ¡Ğ¸Ğ½Ğº', 'áƒ¡áƒ˜áƒœáƒ¥');
  } else if (status === 'offline') {
    dot.style.background = '#ef4444';
    text.textContent = ls('Offline', 'ĞÑ„Ğ»Ğ°Ğ¹Ğ½', 'áƒáƒ¤áƒšáƒáƒ˜áƒœáƒ˜');
  } else if (status === 'error') {
    dot.style.background = '#ef4444';
    text.textContent = ls('Sync error', 'ĞĞ»Ğ´Ğ°Ğ°', 'áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ');
  } else {
    dot.style.background = '#f59e0b';
    text.textContent = ls('Connecting...', 'Ğ¥Ğ¾Ğ»Ğ±Ğ¾Ğ³Ğ´Ğ¾Ğ¶ Ğ±Ğ°Ğ¹Ğ½Ğ°...', 'áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ...');
  }
}

// ===== LANG =====
function t(key) { return TRANSLATIONS[state.lang][key] || key; }
// Pick string by current language: ls('English', 'ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»', 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜')
function ls(en, mn, ka) { return state.lang === 'en' ? en : state.lang === 'mn' ? mn : ka; }
function stageName(stageId) {
  const s = STAGES.find(s => s.id === stageId);
  return s ? s[state.lang] : stageId;
}
function toggleLang() {
  const def = sessionStorage.getItem('sch_lang_default') || 'mn';
  const alt = sessionStorage.getItem('sch_lang_alt') || 'en';
  state.lang = state.lang === def ? alt : def;
  saveState();
  updateUI();
}

// ===== VIEW =====
function toggleView() {
  state.view = state.view === 'board' ? 'table' : 'board';
  saveState();
  updateUI();
}

// ===== HELPERS =====
function daysBetween(dateStr) {
  const d = new Date(dateStr);
  const now = new Date();
  return Math.floor((now - d) / (1000 * 60 * 60 * 24));
}
function formatDate(dateStr) {
  return new Date(dateStr).toLocaleDateString(state.lang === 'mn' ? 'mn-MN' : 'en-US', {
    year: 'numeric', month: 'short', day: 'numeric'
  });
}
function formatEur(amount) {
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount || 0);
}
function getTotalPaid(order) {
  return (order.payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
}
function getTotalInvoiced(order) {
  return (order.invoices || []).reduce((s, inv) => s + (inv.amount || 0), 0);
}
function getRemaining(order) {
  return getTotalInvoiced(order) - getTotalPaid(order);
}
function getClientColor(clientName) {
  const idx = state.clients.indexOf(clientName);
  return idx >= 0 ? idx % 8 : 0;
}
function getFilteredOrders() {
  let orders = state.orders;
  const search = document.getElementById('searchInput').value.toLowerCase();
  const client = document.getElementById('filterClient').value;
  const stage = document.getElementById('filterStage').value;
  if (search) orders = orders.filter(o =>
    o.name.toLowerCase().includes(search) ||
    (o.description || '').toLowerCase().includes(search) ||
    (o.receivedFrom || '').toLowerCase().includes(search) ||
    (o.emailSubject || '').toLowerCase().includes(search) ||
    (o.filePath || '').toLowerCase().includes(search) ||
    (o.attachments || []).some(a => a.toLowerCase().includes(search))
  );
  if (client) orders = orders.filter(o => o.client === client);
  if (stage) orders = orders.filter(o => o.stage === stage);
  const year = document.getElementById('filterYear').value;
  if (year) orders = orders.filter(o => String(o.year) === year);
  // Client-role users are always locked to their own client
  const clientLock = sessionStorage.getItem('sch_client');
  if (clientLock) orders = orders.filter(o => o.client === clientLock);
  return orders;
}

// ===== RENDER =====
function updateUI() {
  // Update sync status text for current language
  const syncDot = document.getElementById('syncDot');
  if (syncDot) {
    const color = syncDot.style.background;
    if (color.includes('10b981') || color.includes('rgb(16, 185, 129)')) setSyncStatus('online');
    else if (color.includes('ef4444') || color.includes('rgb(239, 68, 68)')) setSyncStatus('offline');
    else setSyncStatus('connecting');
  }
  document.getElementById('appTitle').textContent = t('title');
  document.getElementById('btnNewOrder').textContent = t('newOrder');
  document.getElementById('btnManageClients').textContent = t('clients');
  document.getElementById('searchInput').placeholder = t('search');
  const _ld = sessionStorage.getItem('sch_lang_default') || 'mn';
  const _la = sessionStorage.getItem('sch_lang_alt') || 'en';
  const _langLabels = { en: 'ğŸ‡¬ğŸ‡§ English', mn: 'ğŸ‡²ğŸ‡³ ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»', ka: 'ğŸ‡¬ğŸ‡ª áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜' };
  document.getElementById('btnLang').textContent =
    state.lang === _ld ? _langLabels[_la] : _langLabels[_ld];
  document.getElementById('btnView').textContent = state.view === 'board' ? t('tableView') : t('boardView');
  document.getElementById('modalNewTitle').textContent = t('newOrderTitle');
  document.getElementById('lblOrderName').textContent = t('orderName');
  document.getElementById('lblClient').textContent = t('client');
  document.getElementById('lblDescription').textContent = t('description');
  document.getElementById('lblEmailInfo').textContent = t('emailInfo');
  document.getElementById('lblReceivedFrom').textContent = t('receivedFrom');
  document.getElementById('lblReceivedDate').textContent = t('receivedDate');
  document.getElementById('lblEmailSubject').textContent = t('emailSubject');
  document.getElementById('lblFilesSection').textContent = t('filesSection');
  document.getElementById('lblFilePath').textContent = t('filePath');
  document.getElementById('lblAttachment1').textContent = t('attachment1');
  document.getElementById('lblAttachment2').textContent = t('attachment2');
  document.getElementById('lblAttachment3').textContent = t('attachment3');
  document.getElementById('btnCancel1').textContent = t('cancel');
  document.getElementById('btnSaveOrder').textContent = t('save');
  document.getElementById('modalClientTitle').textContent = t('manageClients');
  document.getElementById('btnAddClient').textContent = t('addClient');
  document.getElementById('newClientName').placeholder = t('clientName');

  // Filters
  const fc = document.getElementById('filterClient');
  const currentClient = fc.value;
  fc.innerHTML = `<option value="">${t('allClients')}</option>`;
  state.clients.forEach(c => {
    fc.innerHTML += `<option value="${c}" ${c === currentClient ? 'selected' : ''}>${c}</option>`;
  });

  const fs = document.getElementById('filterStage');
  const currentStage = fs.value;
  fs.innerHTML = `<option value="">${t('allStages')}</option>`;
  STAGES.forEach(s => {
    fs.innerHTML += `<option value="${s.id}" ${s.id === currentStage ? 'selected' : ''}>${s[state.lang]}</option>`;
  });

  const fy = document.getElementById('filterYear');
  const currentYear = fy.value;
  fy.innerHTML = `<option value="">${t('allYears')}</option>`;
  const years = [...new Set(state.orders.map(o => o.year).filter(Boolean))].sort((a, b) => b - a);
  years.forEach(y => {
    fy.innerHTML += `<option value="${y}" ${String(y) === currentYear ? 'selected' : ''}>${y}</option>`;
  });

  document.getElementById('lblYear').textContent = t('year');

  // Client select in new order modal
  const cs = document.getElementById('inputOrderClient');
  cs.innerHTML = '';
  state.clients.forEach(c => {
    cs.innerHTML += `<option value="${c}">${c}</option>`;
  });

  renderBoard();
  renderTable();
  renderStats();

  // Toggle views
  document.getElementById('boardContainer').classList.toggle('hidden', state.view !== 'board');
  document.getElementById('tableView').classList.toggle('active', state.view === 'table');

  // Role-based UI controls
  const _role = sessionStorage.getItem('sch_role');
  const clientLock = sessionStorage.getItem('sch_client');
  const isClient = _role === 'client';
  const isColleague = _role === 'colleague';
  const isClientOrColleague = isClient || isColleague;
  const hide = el => { if (el) el.style.display = 'none'; };
  const show = (el, display) => { if (el) el.style.display = display || ''; };
  if (isClientOrColleague) {
    // Colleague CAN create new orders (they receive drawings); client cannot
    if (isClient) hide(document.getElementById('btnNewOrder'));
    else show(document.getElementById('btnNewOrder'), 'inline-flex');
    hide(document.getElementById('btnManageClients'));
    hide(document.getElementById('filterClient'));
    hide(document.getElementById('btnExport'));
    hide(document.getElementById('lblImport'));
    const lbl = document.getElementById('clientViewLabel');
    if (lbl) {
      lbl.style.display = 'inline-flex';
      lbl.textContent = clientLock ? 'ğŸ‘ ' + clientLock : 'ğŸ‘ All Clients';
    }
  } else {
    show(document.getElementById('btnNewOrder'), 'inline-flex');
    show(document.getElementById('btnManageClients'), 'inline-flex');
    show(document.getElementById('filterClient'));
    show(document.getElementById('btnExport'));
    show(document.getElementById('lblImport'));
    hide(document.getElementById('clientViewLabel'));
  }
}

function renderStats() {
  const orders = state.orders;
  const active = orders.filter(o => o.stage !== 'completed').length;
  const stuck = orders.filter(o => o.stage !== 'completed' && daysBetween(o.stageDate) >= 7).length;
  const done = orders.filter(o => o.stage === 'completed').length;
  const totalInvoiced = orders.reduce((s, o) => s + getTotalInvoiced(o), 0);
  const totalPaid = orders.reduce((s, o) => s + getTotalPaid(o), 0);

  document.getElementById('statsBar').innerHTML = `
    <div class="stat-item"><span class="stat-num">${orders.length}</span> ${t('totalOrders')}</div>
    <div class="stat-item"><span class="stat-num">${active}</span> ${t('activeOrders')}</div>
    <div class="stat-item ${stuck > 0 ? 'stat-warning' : ''}"><span class="stat-num ${stuck > 0 ? 'stat-warning' : ''}">${stuck}</span> ${t('stuckOrders')}</div>
    <div class="stat-item"><span class="stat-num">${done}</span> ${t('completedOrders')}</div>
    <div class="stat-item" style="margin-left:auto"><span style="font-size:0.8rem">${t('totalInvoiced')}:</span> <span class="stat-num" style="font-size:0.95rem">${formatEur(totalInvoiced)}</span></div>
    <div class="stat-item"><span style="font-size:0.8rem">${t('totalReceived')}:</span> <span class="stat-num" style="font-size:0.95rem;color:var(--success)">${formatEur(totalPaid)}</span></div>
  `;
}

function renderBoard() {
  const orders = getFilteredOrders();
  const board = document.getElementById('board');
  board.innerHTML = '';

  // Stage indices for the first 4 workflow stages (managed by colleague/admin)
  const EARLY_STAGE_IDS = ['drawing_received', 'review', 'sent_to_client', 'client_approved'];

  // Build the inner HTML for a past-stage card â€” each stage shows only its own relevant data
  function pastStageCardHtml(order, stageId) {
    const done = `<span style="font-size:0.7rem;color:var(--success);font-weight:700;white-space:nowrap">âœ“ ${ls('Done', 'Ğ”ÑƒÑƒÑÑĞ°Ğ½', 'áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ')}</span>`;
    const lbl = (txt) => `<span style="color:var(--text-light);min-width:0">${txt}</span>`;
    const val = (txt) => `<span style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(txt)}</span>`;
    const row = (label, text) => text
      ? `<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:0.75rem;overflow:hidden">${lbl(label)}${val(text)}</div>`
      : '';
    // Author badge: Ts = admin (you), A = Ayush (colleague)
    const authorBadge = (role) => {
      if (!role) return '';
      const isAdmin = role === 'admin';
      return `<span style="font-size:0.68rem;font-weight:800;background:${isAdmin ? '#0ea5e9' : '#f97316'};color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0" title="${isAdmin ? 'Tsogt' : 'Ayush'}">${isAdmin ? 'Ts' : 'A'}</span>`;
    };

    if (stageId === 'drawing_received') {
      // Stage 1: show only v1 (first drawing received) â€” later versions belong to Step 2
      const drawings = order.drawings || [];
      const first = drawings.length > 0 ? drawings[0] : null;
      return `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:4px;margin-bottom:3px">
          <div class="card-title" style="color:var(--text-light)">${escHtml(order.name)}</div>
          <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">${authorBadge(order.stage1FilledBy)}${done}</div>
        </div>
        <div class="card-client" style="margin-bottom:4px">
          <span class="client-dot client-color-${getClientColor(order.client)}"></span>
          ${escHtml(order.client)}
        </div>
        ${first && first.date ? row(ls('Received:', 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½:', 'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ:'), formatDate(first.date)) : ''}
        ${first && first.from ? row(ls('From:', 'Ğ˜Ğ»Ğ³ÑÑĞ³Ñ‡:', 'áƒ’áƒáƒ›áƒáƒ›áƒ’áƒ–áƒáƒ•áƒœáƒ˜:'), first.from) : ''}
      `;
    }
    if (stageId === 'review') {
      // Stage 2: show v2+ drawing versions + products list + auto-calculated duration
      const products = order.reviewProducts || [];
      const catLabel = c => ({
        window:   state.lang === 'en' ? 'Window'        : state.lang === 'mn' ? 'Ğ¦Ğ¾Ğ½Ñ…'              : 'áƒ¤áƒáƒœáƒ¯áƒáƒ áƒ',
        door:     state.lang === 'en' ? 'Door'          : state.lang === 'mn' ? 'Ğ¥Ğ°Ğ°Ğ»Ğ³Ğ°'            : 'áƒ™áƒáƒ áƒ˜',
        facade:   state.lang === 'en' ? 'Facade'        : state.lang === 'mn' ? 'Ğ¤Ğ°ÑĞ°Ğ´'             : 'áƒ¤áƒáƒ¡áƒáƒ“áƒ˜',
        interior: state.lang === 'en' ? 'Interior Wall' : state.lang === 'mn' ? 'Ğ”Ğ¾Ñ‚Ğ¾Ñ€ ÑˆĞ¸Ğ»ÑĞ½ Ñ…Ğ°Ğ½Ğ°' : 'áƒ¨áƒ˜áƒ“áƒ áƒ›áƒ˜áƒœáƒ˜áƒ¡ áƒ™áƒ”áƒ“áƒ”áƒšáƒ˜',
        sliding:  state.lang === 'en' ? 'Sliding Door'  : state.lang === 'mn' ? 'Ğ“Ò¯Ğ¹Ğ´ÑĞ³ Ñ…Ğ°Ğ°Ğ»Ğ³Ğ°'   : 'áƒ¡áƒ áƒ˜áƒáƒšáƒ áƒ™áƒáƒ áƒ˜'
      }[c] || c);
      // Extra versions (v2, v3, ...) â€” all drawings after the first one
      const drawings = order.drawings || [];
      const extraVersions = drawings.slice(1); // skip v1, it belongs to Step 1
      const versionLines = extraVersions.length > 0
        ? extraVersions.map((d, i) => `<div style="font-size:0.73rem;color:var(--text);padding:1px 0">
            <span style="font-size:0.68rem;background:#dbeafe;color:#1d4ed8;border-radius:4px;padding:0 4px;font-weight:700;margin-right:4px">v${i + 2}</span>
            ${d.date ? `<span style="font-weight:500">${formatDate(d.date)}</span>` : ''}
            ${d.from ? `<span style="color:var(--text-light)"> Â· </span><span>${escHtml(d.from)}</span>` : ''}
          </div>`).join('')
        : '';
      // Auto-calculate duration: from latest drawing date to sent date (or today)
      const latestDrawDate = drawings.length > 0 ? drawings[drawings.length - 1].date : null;
      const endDate = order.sentDate || new Date().toISOString().split('T')[0];
      let autoDuration = '';
      if (latestDrawDate && endDate) {
        const d1 = new Date(latestDrawDate), d2 = new Date(endDate);
        const diff = Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
        if (diff >= 0) autoDuration = diff + ' ' + ls(diff === 1 ? 'day' : 'days', 'Ó©Ğ´Ó©Ñ€', 'áƒ“áƒ¦áƒ”');
      }
      const prodLines = products.length > 0
        ? products.map(p => `<div style="font-size:0.73rem;color:var(--text);padding:1px 0">
            <span style="font-weight:600;color:var(--primary)">${catLabel(p.category)}</span>
            <span style="color:var(--text-light)"> Â· </span><span style="font-family:monospace">${escHtml(p.system || 'â€”')}</span>
            <span style="color:var(--text-light)"> Â· </span>${p.m2 ? escHtml(String(p.m2)) + ' mÂ²' : 'â€”'}
            <span style="color:var(--text-light)"> Â· </span>${p.color ? escHtml(p.color) : 'â€”'}${p.finish === 'fine' ? ' <span style="font-size:0.68rem;font-weight:700;background:#ede9fe;color:#6d28d9;border-radius:4px;padding:0 4px">FS</span>' : ''}
          </div>`).join('')
        : `<div style="font-size:0.73rem;color:var(--text-light);font-style:italic">${ls('No products yet', 'Ğ‘Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½ Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹', 'áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡')}</div>`;
      const totalM2 = products.reduce((sum, p) => sum + (parseFloat(p.m2) || 0), 0);
      const totalM2Html = totalM2 > 0
        ? `<span style="font-size:0.75rem;font-weight:700;background:#dcfce7;color:#15803d;border-radius:8px;padding:1px 8px;white-space:nowrap">${totalM2 % 1 === 0 ? totalM2 : totalM2.toFixed(1)} mÂ² total</span>`
        : '';
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:4px;margin-bottom:4px">
          <span style="font-size:0.78rem;font-weight:600;color:var(--text-light)">${ls('ğŸ” Review', 'ğŸ” Ğ¥ÑĞ½Ğ°Ğ»Ñ‚', 'ğŸ” áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ')}</span>
          <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">${totalM2Html}${authorBadge(order.stage2FilledBy)}${done}</div>
        </div>
        ${autoDuration ? row(ls('Duration:', 'Ğ¥ÑƒĞ³Ğ°Ñ†Ğ°Ğ°:', 'áƒ®áƒáƒœáƒ’áƒ áƒ«áƒšáƒ˜áƒ•áƒáƒ‘áƒ:'), autoDuration) : ''}
        ${versionLines ? `<div style="margin-top:3px;padding-top:3px;border-top:1px solid var(--border)">${versionLines}</div>` : ''}
        <div style="margin-top:3px">${prodLines}</div>
      `;
    }
    if (stageId === 'sent_to_client') {
      // Stage 3: sent date + days waiting for client approval
      const waitDays = order.sentDate ? daysBetween(order.sentDate) : null;
      const waitHtml = waitDays !== null
        ? `<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:0.75rem;overflow:hidden">
            ${lbl(ls('Waiting:', 'Ğ¥Ò¯Ğ»ÑÑĞ¶ Ğ±Ğ°Ğ¹Ğ½Ğ°:', 'áƒšáƒáƒ“áƒ˜áƒœáƒ˜:'))}
            <span style="font-weight:600;color:${waitDays >= 7 ? 'var(--danger)' : waitDays >= 4 ? '#d97706' : 'var(--success)'}">
              ${waitDays} ${ls(waitDays === 1 ? 'day' : 'days', 'Ó©Ğ´Ó©Ñ€', 'áƒ“áƒ¦áƒ”')}
            </span>
          </div>` : '';
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:4px;margin-bottom:4px">
          <span style="font-size:0.78rem;font-weight:600;color:var(--text-light)">${ls('ğŸ“¤ Sent to Client', 'ğŸ“¤ Ğ—Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ´ Ğ¸Ğ»Ğ³ÑÑÑÑĞ½', 'ğŸ“¤ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ—áƒáƒœ')}</span>
          <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">${authorBadge(order.stage3FilledBy)}${done}</div>
        </div>
        ${row(ls('Date:', 'ĞĞ³Ğ½Ğ¾Ğ¾:', 'áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:'), order.sentDate ? formatDate(order.sentDate) : '')}
        ${waitHtml}
        ${row(ls('Subject:', 'Ğ“Ğ°Ñ€Ñ‡Ğ¸Ğ³:', 'áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜:'), order.sentEmailSubject)}
      `;
    }
    if (stageId === 'client_approved') {
      // Stage 4: show only approval date + email subject
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:4px;margin-bottom:4px">
          <span style="font-size:0.78rem;font-weight:600;color:var(--text-light)">${ls('âœ… Approved', 'âœ… Ğ—Ó©Ğ²ÑˆÓ©Ó©Ñ€ÑÓ©Ğ½', 'âœ… áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ“áƒ')}</span>
          <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">${authorBadge(order.stage4FilledBy)}${done}</div>
        </div>
        ${row(ls('Date:', 'ĞĞ³Ğ½Ğ¾Ğ¾:', 'áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:'), order.approvedDate ? formatDate(order.approvedDate) : '')}
        ${row(ls('Subject:', 'Ğ“áƒáƒ Ñ‡Ğ¸Ğ³:', 'áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜:'), order.approvedEmailSubject)}
      `;
    }
    if (stageId === 'sent_abroad') {
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:4px;margin-bottom:4px">
          <span style="font-size:0.78rem;font-weight:600;color:var(--text-light)">${ls('ğŸ‡©ğŸ‡ª Sent to DE/GE', 'ğŸ‡©ğŸ‡ª Ğ“ĞµÑ€Ğ¼Ğ°Ğ½/Ğ“Ò¯Ñ€Ğ¶', 'ğŸ‡©ğŸ‡ª áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ')}</span>
          <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">${authorBadge(order.stage5FilledBy)}${done}</div>
        </div>
        ${row(ls('Date:', 'ĞĞ³Ğ½Ğ¾Ğ¾:', 'áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:'), order.abroadDate ? formatDate(order.abroadDate) : '')}
        ${row(ls('To:', 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²Ğ°Ğ³Ñ‡:', 'áƒ•áƒ˜áƒ¡:'), order.abroadTo)}
        ${row(ls('Subject:', 'Ğ“Ğ°Ñ€Ñ‡Ğ¸Ğ³:', 'áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜:'), order.abroadEmailSubject)}
      `;
    }
    if (stageId === 'calculation_received') {
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:4px;margin-bottom:4px">
          <span style="font-size:0.78rem;font-weight:600;color:var(--text-light)">${ls('ğŸ“Š Calculation Received', 'ğŸ“Š Ğ¢Ğ¾Ğ¾Ñ†Ğ¾Ğ¾ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½', 'ğŸ“Š áƒ™áƒáƒšáƒ™áƒ£áƒšáƒáƒªáƒ˜áƒ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ')}</span>
          <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">${authorBadge(order.stage6FilledBy)}${done}</div>
        </div>
        ${row(ls('Date:', 'ĞĞ³Ğ½Ğ¾Ğ¾:', 'áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:'), order.calcDate ? formatDate(order.calcDate) : '')}
        ${row(ls('From:', 'Ğ˜Ğ»Ğ³ÑÑĞ³Ñ‡:', 'áƒ’áƒáƒ›áƒáƒ›áƒ’áƒ–áƒáƒ•áƒœáƒ˜:'), order.calcFrom)}
      `;
    }
    if (stageId === 'forwarded_mn') {
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:4px;margin-bottom:4px">
          <span style="font-size:0.78rem;font-weight:600;color:var(--text-light)">${ls('ğŸ‡²ğŸ‡³ Forwarded to MN', 'ğŸ‡²ğŸ‡³ ĞœĞ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ´', 'ğŸ‡²ğŸ‡³ áƒ’áƒáƒ“áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ MN')}</span>
          <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">${authorBadge(order.stage7FilledBy)}${done}</div>
        </div>
        ${row(ls('Date:', 'ĞĞ³Ğ½Ğ¾Ğ¾:', 'áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:'), order.forwardDate ? formatDate(order.forwardDate) : '')}
        ${row(ls('To:', 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²Ğ°Ğ³Ñ‡:', 'áƒ•áƒ˜áƒ¡:'), order.forwardTo)}
        ${row(ls('Subject:', 'Ğ“Ğ°Ñ€Ñ‡Ğ¸Ğ³:', 'áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜:'), order.forwardEmailSubject)}
      `;
    }
    return '';
  }

  // Helper: build the full current-stage card HTML for an order
  function buildCurrentCardHtml(order, stage) {
    const days = daysBetween(order.stageDate);
    const isStuck = days >= 7 && stage.id !== 'completed';
    const isWarn = days >= 4 && days < 7 && stage.id !== 'completed';
    const paid = getTotalPaid(order);
    const remaining = getRemaining(order);
    const descHtml = order.description ? `<div class="card-desc" title="${escHtml(order.description)}">${escHtml(order.description)}</div>` : '';
    let metaHtml = '';
    if (order.reviewCycles > 0) metaHtml += `<span class="badge badge-review">ğŸ”„ ${order.reviewCycles}</span>`;
    const attachCount = (order.attachments || []).filter(a => a).length;
    if (attachCount > 0) metaHtml += `<span class="badge" style="background:#e0f2fe;color:#0369a1">ğŸ“ ${attachCount}</span>`;
    const totalInv = getTotalInvoiced(order);
    if (totalInv > 0) {
      if (remaining <= 0) metaHtml += `<span class="badge badge-payment">âœ… ${formatEur(totalInv)}</span>`;
      else if (paid > 0) metaHtml += `<span class="badge badge-unpaid">ğŸ’° ${formatEur(paid)}/${formatEur(totalInv)}</span>`;
      else metaHtml += `<span class="badge badge-invoice">ğŸ’¶ ${formatEur(totalInv)}</span>`;
    }
    const alertClass = isStuck ? 'stuck' : isWarn ? 'warning' : '';
    // Stage-specific extra info shown in the current-stage cell
    let stageExtra = '';
    if (stage.id === 'drawing_received') {
      const drawings = order.drawings || [];
      const first = drawings.length > 0 ? drawings[0] : null;
      const dateRow = first && first.date ? `<div style="font-size:0.75rem;color:var(--text-light)">${ls('Received:', 'Ğ¥Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½:', 'áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ:')} <span style="font-weight:500;color:var(--text)">${formatDate(first.date)}</span></div>` : '';
      const fromRow = first && first.from ? `<div style="font-size:0.75rem;color:var(--text-light)">${ls('From:', 'Ğ˜Ğ»Ğ³ÑÑĞ³Ñ‡:', 'áƒ’áƒáƒ›áƒáƒ›áƒ’áƒ–áƒáƒ•áƒœáƒ˜:')} <span style="font-weight:500;color:var(--text)">${escHtml(first.from)}</span></div>` : '';
      stageExtra = dateRow + fromRow;
    }
    if (stage.id === 'sent_to_client') {
      // Days waiting for client approval since sent date
      if (order.sentDate) {
        const waitDays = daysBetween(order.sentDate);
        stageExtra = `<div style="font-size:0.75rem;margin-top:2px"><span style="color:var(--text-light)">${ls('Sent:', 'Ğ˜Ğ»Ğ³ÑÑÑÑĞ½:', 'áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒšáƒ˜áƒ:')}</span> <span style="font-weight:500">${formatDate(order.sentDate)}</span></div>
          <div style="font-size:0.75rem"><span style="color:var(--text-light)">${ls('Waiting:', 'Ğ¥Ò¯Ğ»ÑÑĞ¶ Ğ±Ğ°Ğ¹Ğ½Ğ°:', 'áƒšáƒáƒ“áƒ˜áƒœáƒ˜:')}</span> <span style="font-weight:600;color:${waitDays >= 7 ? 'var(--danger)' : waitDays >= 4 ? 'var(--warning)' : 'var(--success)'}">${waitDays} ${ls(waitDays === 1 ? 'day' : 'days', 'Ó©Ğ´Ó©Ñ€', 'áƒ“áƒ¦áƒ”')}</span></div>`;
      }
    }
    return `<div class="order-card ${alertClass}" style="margin:0;box-shadow:none;border-radius:0;border:none;background:transparent">
      <div class="card-title">${escHtml(order.name)}</div>
      ${descHtml}
      <div class="card-client">
        <span class="client-dot client-color-${getClientColor(order.client)}"></span>
        ${escHtml(order.client)}
      </div>
      <div class="card-meta">
        <span class="card-days ${isStuck ? 'days-danger' : isWarn ? 'days-warn' : 'days-ok'}">
          ${days} ${days === 1 ? t('day') : t('days')}
        </span>
        ${metaHtml}
      </div>
      ${stageExtra ? `<div style="margin-top:5px">${stageExtra}</div>` : ''}
    </div>`;
  }

  // Show all 12 stages as columns so the full pipeline is always visible
  const allColumns = STAGES;

  if (orders.length === 0) {
    board.innerHTML = `<div style="text-align:center;color:var(--text-light);font-size:0.83rem;padding:40px">${t('noOrders')}</div>`;
    return;
  }

  // Build the CSS grid (type column + 12 stage columns)
  const grid = document.createElement('div');
  grid.className = 'board-grid';
  grid.style.gridTemplateColumns = `72px repeat(${allColumns.length}, minmax(230px, 280px))`;
  board.appendChild(grid);

  // Header row â€” type column first, then one cell per stage
  const typeHdr = document.createElement('div');
  typeHdr.className = 'board-grid-header-cell';
  typeHdr.style.cssText = 'justify-content:center;font-size:0.8rem;background:#f8fafc';
  typeHdr.textContent = t('typeCol');
  grid.appendChild(typeHdr);

  allColumns.forEach(stage => {
    const countHere = orders.filter(o => o.stage === stage.id).length;
    const hdr = document.createElement('div');
    hdr.className = 'board-grid-header-cell';
    hdr.innerHTML = `<span>${stage[state.lang]}</span><span class="column-count">${countHere}</span>`;
    grid.appendChild(hdr);
  });

  // Helper: get emoji + label for order type
  const typeInfo = (ot) => {
    if (ot === 'material') return { emoji: 'ğŸ“‹', label: t('typeMaterial') };
    if (ot === 'license')  return { emoji: 'ğŸ”‘', label: t('typeLicense') };
    return { emoji: 'ğŸ“', label: t('typeDrawing') };
  };

  // One row per order â€” type cell first, then cells across all stage columns
  orders.forEach((order, orderIdx) => {
    const orderStageIdx = STAGES.findIndex(s => s.id === order.stage);
    const rowColor = orderIdx % 8;

    // Type indicator cell
    const { emoji, label } = typeInfo(order.orderType);
    const typeCell = document.createElement('div');
    typeCell.className = `board-grid-cell-type row-color-${rowColor}`;
    typeCell.innerHTML = `<span style="font-size:1.5rem;line-height:1">${emoji}</span><span style="font-size:0.62rem;color:var(--text-light);font-weight:600;margin-top:4px;line-height:1.2">${label}</span>`;
    typeCell.onclick = () => openDetailModal(order.id);
    grid.appendChild(typeCell);

    allColumns.forEach(stage => {
      const colStageIdx = STAGES.findIndex(s => s.id === stage.id);
      const cell = document.createElement('div');

      if (colStageIdx === orderStageIdx) {
        // Current stage â€” full card with highlighted border
        cell.className = `board-grid-cell cell-current row-color-${rowColor}`;
        cell.innerHTML = buildCurrentCardHtml(order, stage);
        cell.onclick = () => openDetailModal(order.id);

      } else if (colStageIdx < orderStageIdx) {
        // Past stage â€” dimmed with row color tint
        cell.className = `board-grid-cell row-color-${rowColor}`;
        cell.style.opacity = '0.72';
        cell.title = ls('Click to view details', 'Ğ”ÑĞ»Ğ³ÑÑ€ÑĞ½Ğ³Ò¯Ğ¹ Ò¯Ğ·ÑÑ…Ğ¸Ğ¹Ğ½ Ñ‚ÑƒĞ»Ğ´ Ğ´Ğ°Ñ€Ğ½Ğ° ÑƒÑƒ', 'áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒáƒœáƒáƒ®áƒáƒ•áƒáƒ“ áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ”áƒ—');
        // Early stages have rich summaries; later stages just show the stage name + done badge
        if (EARLY_STAGE_IDS.includes(stage.id)) {
          cell.innerHTML = pastStageCardHtml(order, stage.id);
        } else {
          cell.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:4px">
            <span style="font-size:0.78rem;font-weight:600;color:var(--text-light)">${stage[state.lang]}</span>
            <span style="font-size:0.7rem;color:var(--success);font-weight:700;white-space:nowrap">âœ“ ${ls('Done', 'Ğ”ÑƒÑƒÑÑĞ°Ğ½', 'áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ')}</span>
          </div>`;
        }
        cell.onclick = () => openDetailModal(order.id);

      } else {
        // Future stage â€” empty placeholder
        cell.className = 'board-grid-cell cell-empty';
      }

      grid.appendChild(cell);
    });
  });
}

function renderTable() {
  const orders = getFilteredOrders();
  document.getElementById('tableHead').innerHTML = `
    <tr>
      <th>${t('orderCol')}</th>
      <th>${t('clientCol')}</th>
      <th>${t('stageCol')}</th>
      <th>${t('daysCol')}</th>
      <th>${t('reviewCol')}</th>
      <th>${t('invoiceCol')}</th>
      <th>${t('paidCol')}</th>
      <th>${t('balanceCol')}</th>
      <th>${t('createdCol')}</th>
    </tr>
  `;
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  if (orders.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--text-light);padding:30px">${t('noOrders')}</td></tr>`;
    return;
  }
  orders.forEach(o => {
    const days = daysBetween(o.stageDate);
    const isStuck = days >= 7 && o.stage !== 'completed';
    const paid = getTotalPaid(o);
    const remaining = getRemaining(o);
    const totalInv = getTotalInvoiced(o);
    const tr = document.createElement('tr');
    tr.onclick = () => openDetailModal(o.id);
    tr.innerHTML = `
      <td><strong>${escHtml(o.name)}</strong>${o.description ? `<br><small style="color:var(--text-light)">${escHtml(o.description).substring(0, 40)}${o.description.length > 40 ? '...' : ''}</small>` : ''}</td>
      <td><span class="client-dot client-color-${getClientColor(o.client)}"></span> ${escHtml(o.client)}</td>
      <td>${stageName(o.stage)}</td>
      <td><span class="card-days ${isStuck ? 'days-danger' : days >= 4 ? 'days-warn' : 'days-ok'}">${days}</span></td>
      <td>${o.reviewCycles > 0 ? `<span class="badge badge-review">ğŸ”„ ${o.reviewCycles}</span>` : '0'}</td>
      <td>${totalInv > 0 ? formatEur(totalInv) : '-'}</td>
      <td style="color:var(--success)">${paid > 0 ? formatEur(paid) : '-'}</td>
      <td style="color:${remaining > 0 ? 'var(--danger)' : remaining === 0 && totalInv > 0 ? 'var(--success)' : 'var(--text-light)'}">${totalInv > 0 ? (remaining <= 0 ? 'âœ…' : formatEur(remaining)) : '-'}</td>
      <td>${formatDate(o.created)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== MODALS =====
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function openNewOrderModal() {
  if (state.clients.length === 0) {
    openClientModal();
    return;
  }
  document.getElementById('inputOrderName').value = '';
  document.getElementById('inputOrderDesc').value = '';
  document.getElementById('inputOrderYear').value = new Date().getFullYear();
  document.getElementById('inputReceivedFrom').value = '';
  document.getElementById('inputReceivedDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('inputEmailSubject').value = '';
  document.getElementById('inputFilePath').value = '';
  document.getElementById('inputAttach1').value = '';
  document.getElementById('inputAttach2').value = '';
  document.getElementById('inputAttach3').value = '';
  // Reset type to drawing
  document.querySelector('input[name="inputOrderType"][value="drawing"]').checked = true;
  // Set translated labels
  document.getElementById('lblOrderType').textContent = t('orderType');
  document.getElementById('typeNameDrawing').textContent = t('typeDrawing');
  document.getElementById('typeNameMaterial').textContent = t('typeMaterial');
  document.getElementById('typeNameLicense').textContent = t('typeLicense');
  openModal('newOrderModal');
}

function saveNewOrder() {
  const name = document.getElementById('inputOrderName').value.trim();
  const client = document.getElementById('inputOrderClient').value;
  const desc = document.getElementById('inputOrderDesc').value.trim();
  if (!name) return;

  const year = parseInt(document.getElementById('inputOrderYear').value) || new Date().getFullYear();
  const orderType = document.querySelector('input[name="inputOrderType"]:checked').value;
  const receivedFrom = document.getElementById('inputReceivedFrom').value.trim();
  const receivedDate = document.getElementById('inputReceivedDate').value;
  const emailSubject = document.getElementById('inputEmailSubject').value.trim();
  const filePath = document.getElementById('inputFilePath').value.trim();
  const attachments = [
    document.getElementById('inputAttach1').value.trim(),
    document.getElementById('inputAttach2').value.trim(),
    document.getElementById('inputAttach3').value.trim()
  ].filter(a => a);

  const now = new Date().toISOString();
  state.orders.push({
    id: state.nextOrderId++,
    name,
    client,
    year,
    orderType,
    description: desc,
    stage: orderType === 'license' ? 'review' : 'drawing_received',
    stageDate: now,
    created: now,
    notes: [],
    history: [{ date: now, text: t('created') }],
    reviewCycles: 0,
    invoices: [],
    nextInvoiceId: 1,
    invoiceAmount: 0,
    payments: [],
    receivedFrom: receivedFrom,
    receivedDate: receivedDate || now.split('T')[0],
    emailSubject: emailSubject,
    filePath: filePath,
    attachments: attachments,
    driveLink: '',
    drawings: receivedFrom || receivedDate || emailSubject
      ? [{ id: 1, date: receivedDate || now.split('T')[0], from: receivedFrom, subject: emailSubject, driveLink: '' }]
      : [],
    nextDrawingId: receivedFrom || receivedDate || emailSubject ? 2 : 1,
    reviewDate: '',
    reviewSummary: '',
    reviewDriveLink: '',
    sentDate: '',
    sentEmailSubject: '',
    sentDriveLink: '',
    approvedDate: '',
    approvedEmailSubject: '',
    approvedDriveLink: ''
  });
  saveState();
  closeModal('newOrderModal');
  updateUI();
}

// ===== DETAIL MODAL WITH TABS =====
let currentDetailTab = 'info';

function openDetailModal(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  document.getElementById('detailTitle').textContent = order.name;

  const days = daysBetween(order.stageDate);
  const stageIdx = STAGES.findIndex(s => s.id === order.stage);
  const paid = getTotalPaid(order);
  const remaining = getRemaining(order);

  // --- TAB: INFO ---
  // Helper: render a Google Drive link cell
  const driveCell = (link) => link
    ? `<a href="${escHtml(link)}" target="_blank" rel="noopener" style="color:#1a73e8;font-weight:600;font-size:0.85rem">${t('openInDrive')}</a>`
    : `<em style="color:var(--text-light)">${t('noDriveLink')}</em>`;

  // Helper: show Edit button only for admin/colleague
  const canEdit = ['admin','colleague'].includes(sessionStorage.getItem('sch_role'));

  const typeEmoji = order.orderType === 'material' ? 'ğŸ“‹' : order.orderType === 'license' ? 'ğŸ”‘' : 'ğŸ“';
  const typeLabel = order.orderType === 'material' ? t('typeMaterial') : order.orderType === 'license' ? t('typeLicense') : t('typeDrawing');

  let infoHtml = `
    <div class="detail-section" style="padding:10px 14px">
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:8px">
          <label style="font-weight:600;font-size:0.85rem;margin:0">${t('year')}:</label>
          ${canEdit
            ? `<input type="number" id="orderYearInput" value="${order.year || ''}" min="2020" max="2099"
                style="width:90px;padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:0.9rem;text-align:center">
               <button class="btn btn-primary btn-sm" onclick="saveOrderYear(${order.id})">${t('saveChanges')}</button>`
            : `<span style="font-size:0.95rem;font-weight:700;color:var(--text)">${order.year || 'â€”'}</span>`
          }
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label style="font-weight:600;font-size:0.85rem;margin:0">${t('orderType')}:</label>
          ${canEdit
            ? `<select id="orderTypeSelect" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:0.9rem">
                <option value="drawing" ${order.orderType === 'drawing' ? 'selected' : ''}>ğŸ“ ${t('typeDrawing')}</option>
                <option value="material" ${order.orderType === 'material' ? 'selected' : ''}>ğŸ“‹ ${t('typeMaterial')}</option>
                <option value="license" ${order.orderType === 'license' ? 'selected' : ''}>ğŸ”‘ ${t('typeLicense')}</option>
               </select>
               <button class="btn btn-primary btn-sm" onclick="saveOrderType(${order.id})">${t('saveChanges')}</button>`
            : `<span style="font-size:0.95rem;font-weight:700;color:var(--text)">${typeEmoji} ${typeLabel}</span>`
          }
        </div>
      </div>
    </div>

    <div class="detail-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h4>ğŸ“‹ ${t('description')}</h4>
        ${canEdit ? `<button class="btn btn-sm" onclick="toggleEditDesc(${order.id})" id="editDescBtn">${t('editInfo')}</button>` : ''}
      </div>
      <div id="descDisplay">
        ${order.description ? `<p style="font-size:0.9rem;color:var(--text);white-space:pre-wrap">${escHtml(order.description)}</p>` : `<p style="color:var(--text-light);font-style:italic">${t('descriptionPlaceholder')}</p>`}
      </div>
      ${canEdit ? `<div id="descEdit" style="display:none">
        <textarea id="editDescInput" style="width:100%;min-height:80px;padding:8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.9rem">${escHtml(order.description || '')}</textarea>
        <div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-sm" onclick="toggleEditDesc(${order.id})">${t('cancel')}</button>
          <button class="btn btn-primary btn-sm" onclick="saveDesc(${order.id})">${t('saveChanges')}</button>
        </div>
      </div>` : ''}
    </div>

    <!-- STAGE 1: Drawing Received â€” version log -->
    <div class="detail-section" style="background:#f0f7ff;border-color:#bfdbfe">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h4>${t('stage1Info')}</h4>
      </div>
      ${(() => {
        const drawings = order.drawings || [];
        if (drawings.length === 0) {
          return `<p style="color:var(--text-light);font-size:0.83rem;font-style:italic;padding:4px 0">${t('noDrawings')}</p>`;
        }
        // Stage 1 shows ONLY the first drawing (v1)
        return drawings.slice(0, 1).map(d => `
          <div id="drawRow-${d.id}" style="border-bottom:1px solid var(--border);padding:8px 0;font-size:0.83rem">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
              <span style="font-weight:700;color:var(--primary);min-width:28px">${t('drawingVersion')}${d.id}</span>
              <div style="flex:1;display:grid;grid-template-columns:auto 1fr;gap:2px 10px;min-width:0">
                <span style="color:var(--text-light)">${t('receivedDate')}:</span>
                <span>${d.date ? formatDate(d.date) : '<em style="color:var(--text-light)">â€”</em>'}</span>
                <span style="color:var(--text-light)">${t('sender')}:</span>
                <span>${d.from ? escHtml(d.from) : '<em style="color:var(--text-light)">â€”</em>'}</span>
                <span style="color:var(--text-light)">${t('emailTitle')}:</span>
                <span>${d.subject ? escHtml(d.subject) : '<em style="color:var(--text-light)">â€”</em>'}</span>
                <span style="color:var(--text-light)">${t('driveLink')}:</span>
                <span>${driveCell(d.driveLink)}</span>
              </div>
              ${canEdit ? `<div style="display:flex;gap:4px;flex-shrink:0">
                <button class="btn btn-sm" style="padding:2px 8px;font-size:0.73rem" onclick="showEditDrawingForm(${order.id}, ${d.id})">${t('editInfo')}</button>
                ${drawings.length > 1 ? `<button class="btn btn-danger btn-sm" style="padding:2px 6px;font-size:0.73rem" onclick="removeDrawing(${order.id}, ${d.id})">âœ•</button>` : ''}
              </div>` : ''}
            </div>
          </div>
          ${canEdit ? `
          <div id="drawEdit-${d.id}" style="display:none;background:#e8f2ff;border-radius:6px;padding:10px;margin-bottom:4px">
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
              <div style="flex:1;min-width:110px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('receivedDate')}</label>
                <input type="date" id="drawEditDate-${d.id}" value="${d.date || ''}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="flex:1;min-width:130px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('sender')}</label>
                <input type="text" id="drawEditFrom-${d.id}" value="${escHtml(d.from || '')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="flex:2;min-width:150px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('emailTitle')}</label>
                <input type="text" id="drawEditSubject-${d.id}" value="${escHtml(d.subject || '')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="flex:2;min-width:150px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('driveLink')}</label>
                <input type="url" id="drawEditDriveLink-${d.id}" value="${escHtml(d.driveLink || '')}" placeholder="${t('driveLinkPlaceholder')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="display:flex;gap:4px;align-self:flex-end">
                <button class="btn btn-sm" onclick="showEditDrawingForm(${order.id}, ${d.id})">${t('cancel')}</button>
                <button class="btn btn-primary btn-sm" onclick="saveEditDrawing(${order.id}, ${d.id})">${t('saveChanges')}</button>
              </div>
            </div>
          </div>` : ''}
        `).join('');
      })()}
    </div>

    <!-- STAGE 2: Review & Correction -->
    <div class="detail-section" style="background:#fffbeb;border-color:#fde68a">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h4>${t('stage2Info')}</h4>
        ${canEdit ? `<button class="btn btn-primary btn-sm" onclick="showAddDrawingForm(${order.id})">${t('addDrawingVersion')}</button>` : ''}
      </div>
      ${(() => {
        const drawings = order.drawings || [];
        const extraDrawings = drawings.slice(1); // v2, v3, v4...
        if (extraDrawings.length === 0) return '';
        return `<div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #fde68a">` +
          extraDrawings.map(d => `
          <div id="drawRow-${d.id}" style="border-bottom:1px solid var(--border);padding:8px 0;font-size:0.83rem">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
              <span style="font-weight:700;color:var(--primary);min-width:28px">${t('drawingVersion')}${d.id}</span>
              <div style="flex:1;display:grid;grid-template-columns:auto 1fr;gap:2px 10px;min-width:0">
                <span style="color:var(--text-light)">${t('receivedDate')}:</span>
                <span>${d.date ? formatDate(d.date) : '<em style="color:var(--text-light)">â€”</em>'}</span>
                <span style="color:var(--text-light)">${t('sender')}:</span>
                <span>${d.from ? escHtml(d.from) : '<em style="color:var(--text-light)">â€”</em>'}</span>
                <span style="color:var(--text-light)">${t('emailTitle')}:</span>
                <span>${d.subject ? escHtml(d.subject) : '<em style="color:var(--text-light)">â€”</em>'}</span>
                <span style="color:var(--text-light)">${t('driveLink')}:</span>
                <span>${driveCell(d.driveLink)}</span>
              </div>
              ${canEdit ? `<div style="display:flex;gap:4px;flex-shrink:0">
                <button class="btn btn-sm" style="padding:2px 8px;font-size:0.73rem" onclick="showEditDrawingForm(${order.id}, ${d.id})">${t('editInfo')}</button>
                <button class="btn btn-danger btn-sm" style="padding:2px 6px;font-size:0.73rem" onclick="removeDrawing(${order.id}, ${d.id})">âœ•</button>
              </div>` : ''}
            </div>
          </div>
          ${canEdit ? `
          <div id="drawEdit-${d.id}" style="display:none;background:#fef9c3;border-radius:6px;padding:10px;margin-bottom:4px">
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
              <div style="flex:1;min-width:110px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('receivedDate')}</label>
                <input type="date" id="drawEditDate-${d.id}" value="${d.date || ''}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="flex:1;min-width:130px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('sender')}</label>
                <input type="text" id="drawEditFrom-${d.id}" value="${escHtml(d.from || '')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="flex:2;min-width:150px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('emailTitle')}</label>
                <input type="text" id="drawEditSubject-${d.id}" value="${escHtml(d.subject || '')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="flex:2;min-width:150px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('driveLink')}</label>
                <input type="url" id="drawEditDriveLink-${d.id}" value="${escHtml(d.driveLink || '')}" placeholder="${t('driveLinkPlaceholder')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="display:flex;gap:4px;align-self:flex-end">
                <button class="btn btn-sm" onclick="showEditDrawingForm(${order.id}, ${d.id})">${t('cancel')}</button>
                <button class="btn btn-primary btn-sm" onclick="saveEditDrawing(${order.id}, ${d.id})">${t('saveChanges')}</button>
              </div>
            </div>
          </div>` : ''}
        `).join('') + `</div>`;
      })()}
      ${canEdit ? `
      <div id="addDrawingForm" style="display:none;background:#fef9c3;border-radius:6px;padding:10px;margin-bottom:10px">
        <div style="font-size:0.8rem;font-weight:700;margin-bottom:8px;color:var(--primary)">${t('addDrawingVersion')}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:110px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('receivedDate')}</label>
            <input type="date" id="newDrawDate" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
          </div>
          <div style="flex:1;min-width:130px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('sender')}</label>
            <input type="text" id="newDrawFrom" placeholder="sender@email.com" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
          </div>
          <div style="flex:2;min-width:150px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('emailTitle')}</label>
            <input type="text" id="newDrawSubject" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
          </div>
          <div style="flex:2;min-width:150px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('driveLink')}</label>
            <input type="url" id="newDrawDriveLink" placeholder="${t('driveLinkPlaceholder')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
          </div>
          <div style="display:flex;gap:4px;align-self:flex-end">
            <button class="btn btn-sm" onclick="showAddDrawingForm(${order.id})">${t('cancel')}</button>
            <button class="btn btn-primary btn-sm" onclick="saveNewDrawing(${order.id})">${t('saveChanges')}</button>
          </div>
        </div>
      </div>` : ''}

      <!-- Duration row (always editable inline) -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;font-size:0.85rem">
        <span style="color:var(--text-light);white-space:nowrap">${t('reviewDuration')}:</span>
        ${canEdit
          ? `<input type="number" id="editReviewDuration" value="${escHtml(order.reviewDuration || '')}"
               min="0" step="0.5" placeholder="${t('reviewDurationPlaceholder')}"
               style="width:90px;padding:4px 8px;border:1px solid var(--border);border-radius:5px;font-size:0.85rem"
               onchange="saveDuration(${order.id})">
             <span style="color:var(--text-light);font-size:0.8rem">${ls('days', 'Ó©Ğ´Ó©Ñ€', 'áƒ“áƒ¦áƒ”')}</span>`
          : `<span>${order.reviewDuration ? escHtml(String(order.reviewDuration)) + ' ' + ls('days', 'Ó©Ğ´Ó©Ñ€', 'áƒ“áƒ¦áƒ”') : '<em style="color:var(--text-light)">â€”</em>'}</span>`
        }
      </div>

      <!-- Schueco Products list -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:0.83rem;font-weight:700;color:var(--text)">${t('reviewProducts')}</span>
        ${canEdit ? `<button class="btn btn-primary btn-sm" onclick="showAddProductForm(${order.id})">${t('addProduct')}</button>` : ''}
      </div>
      ${(() => {
        const products = order.reviewProducts || [];
        const catLabel = c => ({ window: t('catWindow'), door: t('catDoor'), facade: t('catFacade'), interior: t('catInterior'), sliding: t('catSliding') }[c] || c);
        if (products.length === 0) {
          return `<p style="color:var(--text-light);font-size:0.83rem;font-style:italic;padding:2px 0 8px">${t('noProducts')}</p>`;
        }
        const finishLabel = f => f === 'fine' ? t('finishFine') : t('finishNormal');
        return `<div style="margin-bottom:8px">` + products.map(p => `
          <div id="prodRow-${p.id}" style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:0.83rem">
            <div style="flex:1;min-width:0;line-height:1.5">
              <span style="font-weight:700;color:var(--primary)">${catLabel(p.category)}</span>
              <span style="color:var(--text-light);margin:0 4px">Â·</span>
              <span style="font-family:monospace;font-weight:600">${p.system ? escHtml(p.system) : '<em style="color:var(--text-light);font-family:inherit">â€”</em>'}</span>
              <span style="color:var(--text-light);margin:0 4px">Â·</span>
              <span>${p.m2 ? escHtml(String(p.m2)) + ' mÂ²' : '<em style="color:var(--text-light)">â€”</em>'}</span>
              <span style="color:var(--text-light);margin:0 4px">Â·</span>
              <span>${p.color ? escHtml(p.color) : '<em style="color:var(--text-light)">â€”</em>'}</span>
              <span style="color:var(--text-light);margin:0 4px">Â·</span>
              <span style="font-size:0.76rem;background:${p.finish === 'fine' ? '#ede9fe' : '#f0fdf4'};color:${p.finish === 'fine' ? '#6d28d9' : '#15803d'};border-radius:10px;padding:1px 7px;font-weight:600">${finishLabel(p.finish || 'normal')}</span>
            </div>
            ${canEdit ? `<div style="display:flex;gap:4px;flex-shrink:0">
              <button class="btn btn-sm" style="padding:2px 8px;font-size:0.73rem" onclick="showEditProductForm(${order.id}, ${p.id})">${t('editInfo')}</button>
              <button class="btn btn-danger btn-sm" style="padding:2px 6px;font-size:0.73rem" onclick="removeProduct(${order.id}, ${p.id})">âœ•</button>
            </div>` : ''}
          </div>
          ${canEdit ? `
          <div id="prodEdit-${p.id}" style="display:none;background:#fef9c3;border-radius:6px;padding:10px;margin-bottom:4px">
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
              <div style="min-width:110px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productCategory')}</label>
                <select id="prodEditCat-${p.id}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
                  <option value="window" ${p.category === 'window' ? 'selected' : ''}>${t('catWindow')}</option>
                  <option value="door" ${p.category === 'door' ? 'selected' : ''}>${t('catDoor')}</option>
                  <option value="facade" ${p.category === 'facade' ? 'selected' : ''}>${t('catFacade')}</option>
                  <option value="interior" ${p.category === 'interior' ? 'selected' : ''}>${t('catInterior')}</option>
                  <option value="sliding" ${p.category === 'sliding' ? 'selected' : ''}>${t('catSliding')}</option>
                </select>
              </div>
              <div style="flex:1;min-width:120px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productSystem')}</label>
                <input type="text" id="prodEditSystem-${p.id}" value="${escHtml(p.system || '')}" placeholder="${t('productSystemPlaceholder')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem;font-family:monospace">
              </div>
              <div style="min-width:80px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productM2')} (mÂ²)</label>
                <input type="number" id="prodEditM2-${p.id}" value="${p.m2 || ''}" min="0" step="0.01" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="flex:2;min-width:150px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productColor')}</label>
                <input type="text" id="prodEditColor-${p.id}" value="${escHtml(p.color || '')}" placeholder="${t('productColorPlaceholder')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              </div>
              <div style="min-width:130px">
                <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productFinish')}</label>
                <select id="prodEditFinish-${p.id}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
                  <option value="normal" ${(p.finish || 'normal') === 'normal' ? 'selected' : ''}>${t('finishNormal')}</option>
                  <option value="fine" ${p.finish === 'fine' ? 'selected' : ''}>${t('finishFine')}</option>
                </select>
              </div>
              <div style="display:flex;gap:4px;align-self:flex-end">
                <button class="btn btn-sm" onclick="showEditProductForm(${order.id}, ${p.id})">${t('cancel')}</button>
                <button class="btn btn-primary btn-sm" onclick="saveEditProduct(${order.id}, ${p.id})">${t('saveChanges')}</button>
              </div>
            </div>
          </div>` : ''}
        `).join('') + `</div>`;
      })()}

      <!-- Add product form -->
      ${canEdit ? `
      <div id="addProductForm" style="display:none;background:#fef9c3;border-radius:6px;padding:10px;margin-top:4px">
        <div style="font-size:0.8rem;font-weight:700;margin-bottom:8px;color:#92400e">${t('addProduct')}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
          <div style="min-width:110px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productCategory')}</label>
            <select id="newProdCat" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              <option value="window">${t('catWindow')}</option>
              <option value="door">${t('catDoor')}</option>
              <option value="facade">${t('catFacade')}</option>
              <option value="interior">${t('catInterior')}</option>
              <option value="sliding">${t('catSliding')}</option>
            </select>
          </div>
          <div style="flex:1;min-width:120px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productSystem')}</label>
            <input type="text" id="newProdSystem" placeholder="${t('productSystemPlaceholder')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem;font-family:monospace">
          </div>
          <div style="min-width:80px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productM2')} (mÂ²)</label>
            <input type="number" id="newProdM2" min="0" step="0.01" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
          </div>
          <div style="flex:2;min-width:150px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productColor')}</label>
            <input type="text" id="newProdColor" placeholder="${t('productColorPlaceholder')}" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
          </div>
          <div style="min-width:130px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('productFinish')}</label>
            <select id="newProdFinish" style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
              <option value="normal">${t('finishNormal')}</option>
              <option value="fine">${t('finishFine')}</option>
            </select>
          </div>
          <div style="display:flex;gap:4px;align-self:flex-end">
            <button class="btn btn-sm" onclick="showAddProductForm(${order.id})">${t('cancel')}</button>
            <button class="btn btn-primary btn-sm" onclick="saveNewProduct(${order.id})">${t('saveChanges')}</button>
          </div>
        </div>
      </div>` : ''}

      <!-- Correction notes (simple inline edit) -->
      ${canEdit ? `
      <div style="margin-top:12px">
        <label style="font-size:0.78rem;font-weight:600;color:var(--text-light);display:block;margin-bottom:4px">${t('reviewSummary')}</label>
        <textarea id="editReviewSummary" placeholder="${t('reviewSummaryPlaceholder')}"
          style="width:100%;min-height:55px;padding:8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.83rem;resize:vertical"
          onchange="saveSummary(${order.id})">${escHtml(order.reviewSummary || '')}</textarea>
      </div>` : order.reviewSummary ? `
      <div style="margin-top:10px;font-size:0.83rem">
        <span style="color:var(--text-light)">${t('reviewSummary')}: </span>
        <span style="white-space:pre-wrap">${escHtml(order.reviewSummary)}</span>
      </div>` : ''}
    </div>

    <!-- STAGE 3: Sent to Client -->
    <div class="detail-section" style="background:#f0fdf4;border-color:#bbf7d0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h4>${t('stage3Info')}</h4>
        ${canEdit ? `<button class="btn btn-sm" onclick="toggleEditStage3(${order.id})">${t('editInfo')}</button>` : ''}
      </div>
      <div id="stage3Display">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;font-size:0.85rem">
          <span style="color:var(--text-light)">${t('sentDate')}:</span>
          <span>${order.sentDate ? formatDate(order.sentDate) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('emailTitle')}:</span>
          <span>${order.sentEmailSubject ? escHtml(order.sentEmailSubject) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('driveLink')}:</span>
          <span>${driveCell(order.sentDriveLink)}</span>
        </div>
      </div>
      ${canEdit ? `<div id="stage3Edit" style="display:none">
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('sentDate')}</label>
          <input type="date" id="editSentDate" value="${order.sentDate ? order.sentDate.split('T')[0] : ''}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('sentEmailSubject')}</label>
          <input type="text" id="editSentEmailSubject" value="${escHtml(order.sentEmailSubject || '')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('driveLink')}</label>
          <input type="url" id="editSentDriveLink" value="${escHtml(order.sentDriveLink || '')}" placeholder="${t('driveLinkPlaceholder')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-sm" onclick="toggleEditStage3(${order.id})">${t('cancel')}</button>
          <button class="btn btn-primary btn-sm" onclick="saveStage3(${order.id})">${t('saveChanges')}</button>
        </div>
      </div>` : ''}
    </div>

    <!-- STAGE 4: Client Approved -->
    <div class="detail-section" style="background:#f0fff4;border-color:#86efac">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h4>${t('stage4Info')}</h4>
        ${canEdit ? `<button class="btn btn-sm" onclick="toggleEditStage4(${order.id})">${t('editInfo')}</button>` : ''}
      </div>
      <div id="stage4Display">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;font-size:0.85rem">
          <span style="color:var(--text-light)">${t('approvedDate')}:</span>
          <span>${order.approvedDate ? formatDate(order.approvedDate) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('emailTitle')}:</span>
          <span>${order.approvedEmailSubject ? escHtml(order.approvedEmailSubject) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('driveLink')}:</span>
          <span>${driveCell(order.approvedDriveLink)}</span>
        </div>
      </div>
      ${canEdit ? `<div id="stage4Edit" style="display:none">
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('approvedDate')}</label>
          <input type="date" id="editApprovedDate" value="${order.approvedDate ? order.approvedDate.split('T')[0] : ''}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('approvedEmailSubject')}</label>
          <input type="text" id="editApprovedEmailSubject" value="${escHtml(order.approvedEmailSubject || '')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('driveLink')}</label>
          <input type="url" id="editApprovedDriveLink" value="${escHtml(order.approvedDriveLink || '')}" placeholder="${t('driveLinkPlaceholder')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-sm" onclick="toggleEditStage4(${order.id})">${t('cancel')}</button>
          <button class="btn btn-primary btn-sm" onclick="saveStage4(${order.id})">${t('saveChanges')}</button>
        </div>
      </div>` : ''}
    </div>

    <!-- STAGE 5: Sent to DE/GE -->
    <div class="detail-section" style="background:#fff7ed;border-color:#fed7aa">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h4>${t('stage5Info')}</h4>
        ${canEdit ? `<button class="btn btn-sm" onclick="toggleEditStage5(${order.id})">${t('editInfo')}</button>` : ''}
      </div>
      <div id="stage5Display">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;font-size:0.85rem">
          <span style="color:var(--text-light)">${t('abroadDate')}:</span>
          <span>${order.abroadDate ? formatDate(order.abroadDate) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('abroadTo')}:</span>
          <span>${order.abroadTo ? escHtml(order.abroadTo) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('abroadEmailSubject')}:</span>
          <span>${order.abroadEmailSubject ? escHtml(order.abroadEmailSubject) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('driveLink')}:</span>
          <span>${driveCell(order.abroadDriveLink)}</span>
        </div>
      </div>
      ${canEdit ? `<div id="stage5Edit" style="display:none">
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('abroadDate')}</label>
          <input type="date" id="editAbroadDate" value="${order.abroadDate ? order.abroadDate.split('T')[0] : ''}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('abroadTo')}</label>
          <input type="text" id="editAbroadTo" value="${escHtml(order.abroadTo || '')}" placeholder="name@schueco.de" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('abroadEmailSubject')}</label>
          <input type="text" id="editAbroadEmailSubject" value="${escHtml(order.abroadEmailSubject || '')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('driveLink')}</label>
          <input type="url" id="editAbroadDriveLink" value="${escHtml(order.abroadDriveLink || '')}" placeholder="${t('driveLinkPlaceholder')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-sm" onclick="toggleEditStage5(${order.id})">${t('cancel')}</button>
          <button class="btn btn-primary btn-sm" onclick="saveStage5(${order.id})">${t('saveChanges')}</button>
        </div>
      </div>` : ''}
    </div>

    <!-- STAGE 6: Calculation Received from DE/GE -->
    <div class="detail-section" style="background:#eff6ff;border-color:#bfdbfe">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h4>${t('stage6Info')}</h4>
        ${canEdit ? `<button class="btn btn-sm" onclick="toggleEditStage6(${order.id})">${t('editInfo')}</button>` : ''}
      </div>
      <div id="stage6Display">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;font-size:0.85rem">
          <span style="color:var(--text-light)">${t('calcDate')}:</span>
          <span>${order.calcDate ? formatDate(order.calcDate) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('calcFrom')}:</span>
          <span>${order.calcFrom ? escHtml(order.calcFrom) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('driveLink')}:</span>
          <span>${driveCell(order.calcDriveLink)}</span>
        </div>
      </div>
      ${canEdit ? `<div id="stage6Edit" style="display:none">
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('calcDate')}</label>
          <input type="date" id="editCalcDate" value="${order.calcDate ? order.calcDate.split('T')[0] : ''}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('calcFrom')}</label>
          <input type="text" id="editCalcFrom" value="${escHtml(order.calcFrom || '')}" placeholder="name@schueco.de" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('driveLink')}</label>
          <input type="url" id="editCalcDriveLink" value="${escHtml(order.calcDriveLink || '')}" placeholder="${t('driveLinkPlaceholder')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-sm" onclick="toggleEditStage6(${order.id})">${t('cancel')}</button>
          <button class="btn btn-primary btn-sm" onclick="saveStage6(${order.id})">${t('saveChanges')}</button>
        </div>
      </div>` : ''}
    </div>

    <!-- STAGE 7: Forwarded to MN Client -->
    <div class="detail-section" style="background:#faf5ff;border-color:#e9d5ff">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h4>${t('stage7Info')}</h4>
        ${canEdit ? `<button class="btn btn-sm" onclick="toggleEditStage7(${order.id})">${t('editInfo')}</button>` : ''}
      </div>
      <div id="stage7Display">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;font-size:0.85rem">
          <span style="color:var(--text-light)">${t('forwardDate')}:</span>
          <span>${order.forwardDate ? formatDate(order.forwardDate) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('forwardTo')}:</span>
          <span>${order.forwardTo ? escHtml(order.forwardTo) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('forwardEmailSubject')}:</span>
          <span>${order.forwardEmailSubject ? escHtml(order.forwardEmailSubject) : '<em style="color:var(--text-light)">â€”</em>'}</span>
          <span style="color:var(--text-light)">${t('driveLink')}:</span>
          <span>${driveCell(order.forwardDriveLink)}</span>
        </div>
      </div>
      ${canEdit ? `<div id="stage7Edit" style="display:none">
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('forwardDate')}</label>
          <input type="date" id="editForwardDate" value="${order.forwardDate ? order.forwardDate.split('T')[0] : ''}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('forwardTo')}</label>
          <input type="text" id="editForwardTo" value="${escHtml(order.forwardTo || '')}" placeholder="client@mak.mn" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('forwardEmailSubject')}</label>
          <input type="text" id="editForwardEmailSubject" value="${escHtml(order.forwardEmailSubject || '')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label style="font-size:0.78rem">${t('driveLink')}</label>
          <input type="url" id="editForwardDriveLink" value="${escHtml(order.forwardDriveLink || '')}" placeholder="${t('driveLinkPlaceholder')}" style="padding:6px 10px;font-size:0.85rem">
        </div>
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button class="btn btn-sm" onclick="toggleEditStage7(${order.id})">${t('cancel')}</button>
          <button class="btn btn-primary btn-sm" onclick="saveStage7(${order.id})">${t('saveChanges')}</button>
        </div>
      </div>` : ''}
    </div>

    <div class="detail-section">
      <h4>ğŸ”„ ${t('reviewCycles')}</h4>
      <div style="display:flex;align-items:center;gap:12px">
        <span class="review-badge">ğŸ”„ ${order.reviewCycles} ${order.reviewCycles === 1 ? t('revision') : t('revisions')}</span>
        <span style="font-size:0.8rem;color:var(--text-light)">${order.reviewCycles === 0 ? ls('No revisions yet', 'Ğ—Ğ°ÑĞ²Ğ°Ñ€ Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹', 'áƒ’áƒáƒ“áƒáƒ¡áƒ˜áƒœáƒ¯áƒ•áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡') : ''}</span>
      </div>
    </div>
    ${canEdit ? `
    <div style="margin-top:10px">
      <div style="display:flex;gap:6px;margin-bottom:12px">
        <textarea id="noteInput" placeholder="${t('enterNote')}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.85rem;resize:none;height:36px"></textarea>
        <button class="btn btn-primary btn-sm" onclick="addNote(${order.id})">${t('addNote')}</button>
      </div>
    </div>` : ''}
  `;

  // Notes
  if ((order.notes || []).length > 0) {
    infoHtml += `<h4 style="margin:8px 0 6px">${t('notes')}</h4>`;
    (order.notes || []).slice().reverse().forEach(n => {
      infoHtml += `<div class="note-item"><div class="note-date">${formatDate(n.date)}</div>${escHtml(n.text)}</div>`;
    });
  }

  // --- TAB: FINANCE ---
  const isAdminFin = sessionStorage.getItem('sch_role') === 'admin';
  const totalInvoiced = getTotalInvoiced(order);
  const orderInvoices = order.invoices || [];

  let financeHtml = `
    <div class="detail-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h4>ğŸ’¶ ${t('invoicesSection')}</h4>
        ${isAdminFin ? `<button class="btn btn-primary btn-sm" onclick="showAddInvoiceForm(${order.id})">+ ${t('addInvoice')}</button>` : ''}
      </div>
      ${orderInvoices.length === 0
        ? `<p style="color:var(--text-light);font-size:0.83rem;font-style:italic;padding:4px 0">${t('noInvoices')}</p>`
        : orderInvoices.map(inv => `
            <div id="invRow-${inv.id}" style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:0.83rem;gap:8px;flex-wrap:wrap">
              <span style="font-weight:700;color:var(--primary);min-width:46px">INV-${inv.id}</span>
              <span style="font-weight:700;min-width:80px">${formatEur(inv.amount)}</span>
              <span style="color:var(--text-light);min-width:78px">${inv.date ? formatDate(inv.date) : 'â€”'}</span>
              <span style="flex:1;color:var(--text-light);font-style:${inv.note ? 'normal' : 'italic'}">${inv.note ? escHtml(inv.note) : 'â€”'}</span>
              ${isAdminFin ? `
                <button class="btn btn-sm" style="padding:2px 8px;font-size:0.73rem" onclick="showEditInvoiceForm(${order.id}, ${inv.id})">${t('editInfo')}</button>
                <button class="btn btn-danger btn-sm" style="padding:2px 6px;font-size:0.73rem" onclick="removeInvoice(${order.id}, ${inv.id})">âœ•</button>
              ` : ''}
            </div>
            ${isAdminFin ? `
            <div id="invEdit-${inv.id}" style="display:none;background:#f0f7ff;border-radius:6px;padding:10px;margin-bottom:4px">
              <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
                <div style="flex:1;min-width:90px">
                  <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('invoiceAmount2')}</label>
                  <input type="number" id="invEditAmount-${inv.id}" value="${inv.amount}" min="0" step="0.01"
                    style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
                </div>
                <div style="flex:1;min-width:90px">
                  <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('invoiceDate')}</label>
                  <input type="date" id="invEditDate-${inv.id}" value="${inv.date || ''}"
                    style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
                </div>
                <div style="flex:2;min-width:120px">
                  <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('invoiceNote')}</label>
                  <input type="text" id="invEditNote-${inv.id}" value="${escHtml(inv.note || '')}"
                    style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem"
                    placeholder="${t('invoiceNotePlaceholder')}">
                </div>
                <div style="display:flex;gap:4px;align-self:flex-end">
                  <button class="btn btn-sm" onclick="showEditInvoiceForm(${order.id}, ${inv.id})">${t('cancel')}</button>
                  <button class="btn btn-primary btn-sm" onclick="saveEditInvoice(${order.id}, ${inv.id})">${t('saveChanges')}</button>
                </div>
              </div>
            </div>` : ''}
          `).join('')
      }
      ${orderInvoices.length > 0 ? `
      <div class="finance-row total" style="margin-top:10px">
        <span>${t('invoiceTotal')}:</span>
        <strong>${formatEur(totalInvoiced)}</strong>
      </div>` : ''}
      ${isAdminFin ? `
      <div id="addInvoiceForm" style="display:none;background:#f0f7ff;border-radius:6px;padding:10px;margin-top:10px">
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:90px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('invoiceAmount2')}</label>
            <input type="number" id="newInvAmount" min="0" step="0.01"
              style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem" placeholder="0.00">
          </div>
          <div style="flex:1;min-width:90px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('invoiceDate')}</label>
            <input type="date" id="newInvDate" value="${new Date().toISOString().split('T')[0]}"
              style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem">
          </div>
          <div style="flex:2;min-width:120px">
            <label style="font-size:0.73rem;font-weight:600;display:block;margin-bottom:2px">${t('invoiceNote')}</label>
            <input type="text" id="newInvNote"
              style="width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.83rem"
              placeholder="${t('invoiceNotePlaceholder')}">
          </div>
          <div style="display:flex;gap:4px;align-self:flex-end">
            <button class="btn btn-sm" onclick="showAddInvoiceForm(${order.id})">${t('cancel')}</button>
            <button class="btn btn-success btn-sm" onclick="saveNewInvoice(${order.id})">${t('saveChanges')}</button>
          </div>
        </div>
      </div>` : ''}
    </div>

    <div class="detail-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <h4>ğŸ’° ${t('payments')}</h4>
      </div>
      ${renderPaymentProgress(order)}
      <div class="finance-row"><span>${t('totalPaid')}:</span><span style="color:var(--success);font-weight:600">${formatEur(paid)}</span></div>
      <div class="finance-row total">
        <span>${t('remaining')}:</span>
        <span class="${remaining <= 0 && totalInvoiced > 0 ? 'paid-full' : 'remaining'}">
          ${remaining <= 0 && totalInvoiced > 0 ? `âœ… ${t('paidInFull')}` : formatEur(remaining)}
        </span>
      </div>
      ${order.payments.length > 0 ? order.payments.map((p, i) => `
        <div class="payment-item">
          <div>
            <div>${formatDate(p.date)}</div>
            ${p.note ? `<div style="font-size:0.75rem;color:var(--text-light)">${escHtml(p.note)}</div>` : ''}
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <strong style="color:var(--success)">${formatEur(p.amount)}</strong>
            ${isAdminFin ? `<button class="btn btn-danger btn-sm" style="padding:2px 6px;font-size:0.7rem" onclick="removePayment(${order.id}, ${i})">âœ•</button>` : ''}
          </div>
        </div>
      `).join('') : `<p style="color:var(--text-light);font-size:0.83rem;padding:8px 0">${t('noPayments')}</p>`}
      ${isAdminFin ? `
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:100px">
            <label style="font-size:0.75rem;font-weight:600;display:block;margin-bottom:2px">${t('paymentAmount')}</label>
            <input type="number" id="payAmount" min="0" step="0.01" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.85rem" placeholder="0.00">
          </div>
          <div style="flex:1;min-width:100px">
            <label style="font-size:0.75rem;font-weight:600;display:block;margin-bottom:2px">${t('paymentDate')}</label>
            <input type="date" id="payDate" value="${new Date().toISOString().split('T')[0]}" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.85rem">
          </div>
          <div style="flex:1;min-width:100px">
            <label style="font-size:0.75rem;font-weight:600;display:block;margin-bottom:2px">${t('paymentNote')}</label>
            <input type="text" id="payNote" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:0.85rem" placeholder="">
          </div>
          <button class="btn btn-success btn-sm" onclick="addPayment(${order.id})">${t('addPayment')}</button>
        </div>
      </div>` : ''}
    </div>
  `;

  // --- TAB: HISTORY ---
  let historyHtml = `<ul class="history-list">`;
  (order.history || []).slice().reverse().forEach(h => {
    historyHtml += `<li class="history-item"><span class="history-date">${formatDate(h.date)}</span><span class="history-text">${escHtml(h.text)}</span></li>`;
  });
  historyHtml += '</ul>';

  document.getElementById('detailBody').innerHTML = `
    <div class="detail-stage">${t('stage')}: ${stageName(order.stage)} â€” <span class="card-days ${days >= 7 ? 'days-danger' : days >= 4 ? 'days-warn' : 'days-ok'}">${days} ${t('daysHere')}</span></div>
    <p style="margin-bottom:12px"><strong>${t('client')}:</strong> <span class="client-dot client-color-${getClientColor(order.client)}"></span> ${escHtml(order.client)}</p>

    <div class="detail-tabs">
      <div class="detail-tab ${currentDetailTab === 'info' ? 'active' : ''}" onclick="switchTab('info', ${order.id})">ğŸ“‹ ${t('info')}</div>
      <div class="detail-tab ${currentDetailTab === 'finance' ? 'active' : ''}" onclick="switchTab('finance', ${order.id})">ğŸ’° ${t('finance')}</div>
      <div class="detail-tab ${currentDetailTab === 'history' ? 'active' : ''}" onclick="switchTab('history', ${order.id})">ğŸ“œ ${t('history')}</div>
    </div>
    <div class="tab-content ${currentDetailTab === 'info' ? 'active' : ''}" id="tabInfo">${infoHtml}</div>
    <div class="tab-content ${currentDetailTab === 'finance' ? 'active' : ''}" id="tabFinance">${financeHtml}</div>
    <div class="tab-content ${currentDetailTab === 'history' ? 'active' : ''}" id="tabHistory">${historyHtml}</div>
  `;

  // Footer buttons â€” role-dependent
  const _footerRole = sessionStorage.getItem('sch_role');
  const COLLEAGUE_MAX = 3; // client_approved is stage index 3
  let footerHtml = '';
  if (_footerRole === 'admin') {
    // Admin: full navigation + delete + send back for review
    if (stageIdx > 0) {
      footerHtml += `<button class="btn" onclick="moveOrder(${order.id}, -1)">${t('prevStage')}</button>`;
    }
    if (stageIdx >= 2) {
      footerHtml += `<button class="btn btn-warning btn-sm" onclick="sendBackForReview(${order.id})">${t('sendBackReview')}</button>`;
    }
    footerHtml += `<button class="btn btn-danger btn-sm" onclick="confirmDeleteOrder(${order.id})">${t('deleteOrder')}</button>`;
    if (stageIdx < STAGES.length - 1) {
      footerHtml += `<button class="btn btn-primary" onclick="moveOrder(${order.id}, 1)">${t('nextStage')}</button>`;
    }
  } else if (_footerRole === 'colleague') {
    // Colleague: prev/next within stages 0â€“3 only, no delete, no send-back
    if (stageIdx > 0 && stageIdx <= COLLEAGUE_MAX) {
      footerHtml += `<button class="btn" onclick="moveOrder(${order.id}, -1)">${t('prevStage')}</button>`;
    }
    if (stageIdx < COLLEAGUE_MAX) {
      footerHtml += `<button class="btn btn-primary" onclick="moveOrder(${order.id}, 1)">${t('nextStage')}</button>`;
    }
  }
  // client role: no footer buttons
  document.getElementById('detailFooter').innerHTML = footerHtml;
  openModal('detailModal');
}

function renderPaymentProgress(order) {
  const totalInvoiced = getTotalInvoiced(order);
  if (totalInvoiced <= 0) return '';
  const paid = getTotalPaid(order);
  const pct = Math.min(100, Math.round((paid / totalInvoiced) * 100));
  const color = pct >= 100 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)';
  return `
    <div style="margin:8px 0 12px">
      <div style="display:flex;justify-content:space-between;font-size:0.78rem;margin-bottom:3px">
        <span>${pct}%</span>
        <span>${formatEur(paid)} / ${formatEur(totalInvoiced)}</span>
      </div>
      <div style="background:#e5e7eb;border-radius:6px;height:8px;overflow:hidden">
        <div style="background:${color};height:100%;width:${pct}%;border-radius:6px;transition:width 0.3s"></div>
      </div>
    </div>
  `;
}

function switchTab(tab, orderId) {
  currentDetailTab = tab;
  openDetailModal(orderId);
}

// ===== ACTIONS =====
function moveOrder(orderId, direction) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const idx = STAGES.findIndex(s => s.id === order.stage);
  const newIdx = idx + direction;
  if (newIdx < 0 || newIdx >= STAGES.length) return;
  // Colleague can only move within stages 0â€“3 (drawing_received â†’ client_approved)
  const _moveRole = sessionStorage.getItem('sch_role');
  if (_moveRole === 'colleague' && (newIdx > 3 || idx > 3)) return;

  order.stage = STAGES[newIdx].id;
  order.stageDate = new Date().toISOString();
  if (!order.history) order.history = [];
  order.history.push({ date: order.stageDate, text: `${t('movedTo')} ${stageName(order.stage)}` });
  saveState();
  closeModal('detailModal');
  updateUI();
}

function sendBackForReview(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.reviewCycles = (order.reviewCycles || 0) + 1;
  order.stage = 'review';
  order.stageDate = new Date().toISOString();
  if (!order.history) order.history = [];
  order.history.push({ date: order.stageDate, text: `${t('sentBackReview')} (#${order.reviewCycles})` });
  saveState();
  closeModal('detailModal');
  updateUI();
}

function addNote(orderId) {
  const input = document.getElementById('noteInput');
  const text = input.value.trim();
  if (!text) return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const now = new Date().toISOString();
  if (!order.notes) order.notes = [];
  if (!order.history) order.history = [];
  order.notes.push({ date: now, text });
  order.history.push({ date: now, text: `${t('noteAdded')}: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}` });
  saveState();
  openDetailModal(orderId);
}

function addPayment(orderId) {
  const amountEl = document.getElementById('payAmount');
  const dateEl = document.getElementById('payDate');
  const noteEl = document.getElementById('payNote');
  const amount = parseFloat(amountEl.value);
  if (!amount || amount <= 0) return;
  const date = dateEl.value || new Date().toISOString().split('T')[0];
  const note = noteEl.value.trim();

  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;

  if (!order.payments) order.payments = [];
  if (!order.history) order.history = [];
  order.payments.push({ date: new Date(date).toISOString(), amount, note });
  order.history.push({ date: new Date().toISOString(), text: `ğŸ’° ${state.lang === 'en' ? 'Payment received' : 'Ğ¢Ó©Ğ»Ğ±Ó©Ñ€ Ñ…Ò¯Ğ»ÑÑĞ½ Ğ°Ğ²ÑĞ°Ğ½'}: ${formatEur(amount)}${note ? ' - ' + note : ''}` });
  saveState();
  currentDetailTab = 'finance';
  openDetailModal(orderId);
}

function removePayment(orderId, paymentIdx) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  if (!order.payments) order.payments = [];
  if (!order.history) order.history = [];
  const p = order.payments[paymentIdx];
  order.payments.splice(paymentIdx, 1);
  order.history.push({ date: new Date().toISOString(), text: `ğŸ’° ${state.lang === 'en' ? 'Payment removed' : 'Ğ¢Ó©Ğ»Ğ±Ó©Ñ€ Ñ…Ğ°ÑĞ°Ğ³Ğ´ÑĞ°Ğ½'}: ${formatEur(p.amount)}` });
  saveState();
  currentDetailTab = 'finance';
  openDetailModal(orderId);
}

function toggleEditDesc(orderId) {
  const display = document.getElementById('descDisplay');
  const edit = document.getElementById('descEdit');
  if (edit.style.display === 'none') {
    edit.style.display = 'block';
    display.style.display = 'none';
  } else {
    edit.style.display = 'none';
    display.style.display = 'block';
  }
}

function saveOrderYear(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const val = parseInt(document.getElementById('orderYearInput').value);
  if (val >= 2020 && val <= 2099) {
    order.year = val;
    saveState();
    updateUI();
  }
}

function saveOrderType(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.orderType = document.getElementById('orderTypeSelect').value;
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
  updateUI();
}

function saveDesc(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.description = document.getElementById('editDescInput').value.trim();
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// ===== STAGE SECTION TOGGLE/SAVE HELPERS =====
function _toggleStageSection(displayId, editId) {
  const display = document.getElementById(displayId);
  const edit = document.getElementById(editId);
  if (!edit) return;
  if (edit.style.display === 'none') {
    edit.style.display = 'block';
    display.style.display = 'none';
  } else {
    edit.style.display = 'none';
    display.style.display = 'block';
  }
}

// Stage 1: Drawing Received â€” version log CRUD
function showAddDrawingForm(orderId) {
  const form = document.getElementById('addDrawingForm');
  if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
}
function saveNewDrawing(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const date = document.getElementById('newDrawDate').value;
  const from = document.getElementById('newDrawFrom').value.trim();
  const subject = document.getElementById('newDrawSubject').value.trim();
  const driveLink = document.getElementById('newDrawDriveLink').value.trim();
  if (!date && !from && !subject) return; // need at least something
  if (!order.drawings) order.drawings = [];
  if (!order.history) order.history = [];
  const newDraw = { id: order.nextDrawingId++, date, from, subject, driveLink };
  order.drawings.push(newDraw);
  order.stage1FilledBy = sessionStorage.getItem('sch_role') || '';
  order.history.push({ date: new Date().toISOString(), text: `ğŸ“¥ ${state.lang === 'en' ? 'Drawing version added' : 'Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ñ…ÑƒĞ²Ğ¸Ğ»Ğ±Ğ°Ñ€ Ğ½ÑĞ¼ÑĞ³Ğ´ÑÑĞ½'}: V${newDraw.id}${date ? ' ' + date : ''}${from ? ' Â· ' + from : ''}` });
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}
function removeDrawing(orderId, drawingId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  if (!order.drawings || order.drawings.length <= 1) return; // keep at least one
  if (!order.history) order.history = [];
  const d = order.drawings.find(x => x.id === drawingId);
  order.drawings = order.drawings.filter(x => x.id !== drawingId);
  order.history.push({ date: new Date().toISOString(), text: `ğŸ“¥ ${state.lang === 'en' ? 'Drawing version removed' : 'Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ñ…ÑƒĞ²Ğ¸Ğ»Ğ±Ğ°Ñ€ Ñ…Ğ°ÑĞ°Ğ³Ğ´ÑĞ°Ğ½'}: V${drawingId}` });
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}
function showEditDrawingForm(orderId, drawingId) {
  const row = document.getElementById(`drawRow-${drawingId}`);
  const editForm = document.getElementById(`drawEdit-${drawingId}`);
  if (!row || !editForm) return;
  const isHidden = editForm.style.display === 'none';
  editForm.style.display = isHidden ? 'block' : 'none';
}
function saveEditDrawing(orderId, drawingId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const d = (order.drawings || []).find(x => x.id === drawingId);
  if (!d) return;
  if (!order.history) order.history = [];
  d.date = document.getElementById(`drawEditDate-${drawingId}`).value;
  d.from = document.getElementById(`drawEditFrom-${drawingId}`).value.trim();
  d.subject = document.getElementById(`drawEditSubject-${drawingId}`).value.trim();
  d.driveLink = document.getElementById(`drawEditDriveLink-${drawingId}`).value.trim();
  order.stage1FilledBy = sessionStorage.getItem('sch_role') || '';
  order.history.push({ date: new Date().toISOString(), text: `ğŸ“¥ ${state.lang === 'en' ? 'Drawing version updated' : 'Ğ—ÑƒÑ€Ğ³Ğ¸Ğ¹Ğ½ Ñ…ÑƒĞ²Ğ¸Ğ»Ğ±Ğ°Ñ€ Ğ·Ğ°ÑĞ°Ğ³Ğ´ÑĞ°Ğ½'}: V${drawingId}` });
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// Stage 2: Review â€” inline duration + product CRUD
function saveDuration(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.reviewDuration = document.getElementById('editReviewDuration').value.trim();
  order.stage2FilledBy = sessionStorage.getItem('sch_role') || '';
  saveState();
}
function saveSummary(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.reviewSummary = document.getElementById('editReviewSummary').value.trim();
  order.stage2FilledBy = sessionStorage.getItem('sch_role') || '';
  saveState();
}
function showAddProductForm(orderId) {
  const form = document.getElementById('addProductForm');
  if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
}
function saveNewProduct(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const category = document.getElementById('newProdCat').value;
  const system = document.getElementById('newProdSystem').value.trim();
  const m2 = parseFloat(document.getElementById('newProdM2').value) || 0;
  const color = document.getElementById('newProdColor').value.trim();
  const finish = document.getElementById('newProdFinish').value;
  if (!system && !m2 && !color) return;
  if (!order.reviewProducts) order.reviewProducts = [];
  if (!order.history) order.history = [];
  const p = { id: order.nextProductId++, category, system, m2, color, finish };
  order.reviewProducts.push(p);
  order.stage2FilledBy = sessionStorage.getItem('sch_role') || '';
  order.history.push({ date: new Date().toISOString(), text: `ğŸ” ${state.lang === 'en' ? 'Product added' : 'Ğ‘Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½ Ğ½ÑĞ¼ÑĞ³Ğ´ÑÑĞ½'}: ${system || category}${m2 ? ' ' + m2 + 'mÂ²' : ''}` });
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}
function removeProduct(orderId, productId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  if (!order.history) order.history = [];
  const p = (order.reviewProducts || []).find(x => x.id === productId);
  order.reviewProducts = (order.reviewProducts || []).filter(x => x.id !== productId);
  order.history.push({ date: new Date().toISOString(), text: `ğŸ” ${state.lang === 'en' ? 'Product removed' : 'Ğ‘Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½ Ñ…Ğ°ÑĞ°Ğ³Ğ´ÑĞ°Ğ½'}: ${p ? (p.system || p.category) : productId}` });
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}
function showEditProductForm(orderId, productId) {
  const editForm = document.getElementById(`prodEdit-${productId}`);
  if (!editForm) return;
  editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
}
function saveEditProduct(orderId, productId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const p = (order.reviewProducts || []).find(x => x.id === productId);
  if (!p) return;
  if (!order.history) order.history = [];
  p.category = document.getElementById(`prodEditCat-${productId}`).value;
  p.system = document.getElementById(`prodEditSystem-${productId}`).value.trim();
  p.m2 = parseFloat(document.getElementById(`prodEditM2-${productId}`).value) || 0;
  p.color = document.getElementById(`prodEditColor-${productId}`).value.trim();
  p.finish = document.getElementById(`prodEditFinish-${productId}`).value;
  order.stage2FilledBy = sessionStorage.getItem('sch_role') || '';
  order.history.push({ date: new Date().toISOString(), text: `ğŸ” ${state.lang === 'en' ? 'Product updated' : 'Ğ‘Ò¯Ñ‚ÑÑĞ³Ğ´ÑÑ…Ò¯Ò¯Ğ½ Ğ·Ğ°ÑĞ°Ğ³Ğ´ÑĞ°Ğ½'}: ${p.system || p.category}` });
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// Stage 3: Sent to Client
function toggleEditStage3(orderId) { _toggleStageSection('stage3Display', 'stage3Edit'); }
function saveStage3(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.sentDate = document.getElementById('editSentDate').value;
  order.sentEmailSubject = document.getElementById('editSentEmailSubject').value.trim();
  order.sentDriveLink = document.getElementById('editSentDriveLink').value.trim();
  order.stage3FilledBy = sessionStorage.getItem('sch_role') || '';
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// Stage 4: Client Approved
function toggleEditStage4(orderId) { _toggleStageSection('stage4Display', 'stage4Edit'); }
function saveStage4(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.approvedDate = document.getElementById('editApprovedDate').value;
  order.approvedEmailSubject = document.getElementById('editApprovedEmailSubject').value.trim();
  order.approvedDriveLink = document.getElementById('editApprovedDriveLink').value.trim();
  order.stage4FilledBy = sessionStorage.getItem('sch_role') || '';
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// Stage 5: Sent to DE/GE
function toggleEditStage5(orderId) { _toggleStageSection('stage5Display', 'stage5Edit'); }
function saveStage5(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.abroadDate = document.getElementById('editAbroadDate').value;
  order.abroadTo = document.getElementById('editAbroadTo').value.trim();
  order.abroadEmailSubject = document.getElementById('editAbroadEmailSubject').value.trim();
  order.abroadDriveLink = document.getElementById('editAbroadDriveLink').value.trim();
  order.stage5FilledBy = sessionStorage.getItem('sch_role') || '';
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// Stage 6: Calculation Received from DE/GE
function toggleEditStage6(orderId) { _toggleStageSection('stage6Display', 'stage6Edit'); }
function saveStage6(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.calcDate = document.getElementById('editCalcDate').value;
  order.calcFrom = document.getElementById('editCalcFrom').value.trim();
  order.calcDriveLink = document.getElementById('editCalcDriveLink').value.trim();
  order.stage6FilledBy = sessionStorage.getItem('sch_role') || '';
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// Stage 7: Forwarded to MN Client
function toggleEditStage7(orderId) { _toggleStageSection('stage7Display', 'stage7Edit'); }
function saveStage7(orderId) {
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  order.forwardDate = document.getElementById('editForwardDate').value;
  order.forwardTo = document.getElementById('editForwardTo').value.trim();
  order.forwardEmailSubject = document.getElementById('editForwardEmailSubject').value.trim();
  order.forwardDriveLink = document.getElementById('editForwardDriveLink').value.trim();
  order.stage7FilledBy = sessionStorage.getItem('sch_role') || '';
  saveState();
  currentDetailTab = 'info';
  openDetailModal(orderId);
}

// ===== MULTI-INVOICE CRUD =====

function showAddInvoiceForm(orderId) {
  if (sessionStorage.getItem('sch_role') !== 'admin') return;
  const form = document.getElementById('addInvoiceForm');
  if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function saveNewInvoice(orderId) {
  if (sessionStorage.getItem('sch_role') !== 'admin') return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const amount = parseFloat(document.getElementById('newInvAmount').value);
  if (!amount || amount <= 0) return;
  const date = document.getElementById('newInvDate').value || new Date().toISOString().split('T')[0];
  const note = document.getElementById('newInvNote').value.trim();
  if (!order.invoices) order.invoices = [];
  if (!order.history) order.history = [];
  const newInv = { id: order.nextInvoiceId++, amount, date, note };
  order.invoices.push(newInv);
  order.history.push({ date: new Date().toISOString(), text: `ğŸ’¶ ${state.lang === 'en' ? 'Invoice added' : 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ» Ğ½ÑĞ¼ÑĞ³Ğ´ÑÑĞ½'}: INV-${newInv.id} ${formatEur(amount)}` });
  saveState();
  currentDetailTab = 'finance';
  openDetailModal(orderId);
}

function removeInvoice(orderId, invoiceId) {
  if (sessionStorage.getItem('sch_role') !== 'admin') return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  if (!order.invoices) order.invoices = [];
  if (!order.history) order.history = [];
  const inv = order.invoices.find(i => i.id === invoiceId);
  if (!inv) return;
  order.invoices = order.invoices.filter(i => i.id !== invoiceId);
  order.history.push({ date: new Date().toISOString(), text: `ğŸ’¶ ${state.lang === 'en' ? 'Invoice removed' : 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ» Ñ…Ğ°ÑĞ°Ğ³Ğ´ÑĞ°Ğ½'}: INV-${invoiceId} ${formatEur(inv.amount)}` });
  saveState();
  currentDetailTab = 'finance';
  openDetailModal(orderId);
}

function showEditInvoiceForm(orderId, invoiceId) {
  if (sessionStorage.getItem('sch_role') !== 'admin') return;
  const row = document.getElementById(`invRow-${invoiceId}`);
  const editForm = document.getElementById(`invEdit-${invoiceId}`);
  if (!row || !editForm) return;
  const isHidden = editForm.style.display === 'none';
  row.style.display = isHidden ? 'none' : 'flex';
  editForm.style.display = isHidden ? 'block' : 'none';
}

function saveEditInvoice(orderId, invoiceId) {
  if (sessionStorage.getItem('sch_role') !== 'admin') return;
  const order = state.orders.find(o => o.id === orderId);
  if (!order) return;
  const inv = order.invoices.find(i => i.id === invoiceId);
  if (!inv) return;
  const amount = parseFloat(document.getElementById(`invEditAmount-${invoiceId}`).value);
  if (!amount || amount <= 0) return;
  const date = document.getElementById(`invEditDate-${invoiceId}`).value;
  const note = document.getElementById(`invEditNote-${invoiceId}`).value.trim();
  if (!order.history) order.history = [];
  const oldAmount = inv.amount;
  inv.amount = amount;
  if (date) inv.date = date;
  inv.note = note;
  order.history.push({ date: new Date().toISOString(), text: `ğŸ’¶ ${state.lang === 'en' ? 'Invoice updated' : 'ĞÑÑ…ÑĞ¼Ğ¶Ğ»ÑĞ» Ğ·Ğ°ÑĞ°Ğ³Ğ´ÑĞ°Ğ½'}: INV-${invoiceId} ${formatEur(oldAmount)} â†’ ${formatEur(amount)}` });
  saveState();
  currentDetailTab = 'finance';
  openDetailModal(orderId);
}

function confirmDeleteOrder(orderId) {
  document.getElementById('detailFooter').innerHTML = `
    <span style="font-size:0.85rem;color:var(--danger);font-weight:600;flex:1">âš ï¸ ${t('deleteConfirmMsg')}</span>
    <button class="btn btn-sm" onclick="openDetailModal(${orderId})">${t('cancel')}</button>
    <button class="btn btn-danger btn-sm" onclick="deleteOrder(${orderId})">${t('deleteConfirmYes')}</button>
  `;
}
function deleteOrder(orderId) {
  state.orders = state.orders.filter(o => o.id !== orderId);
  saveState();
  closeModal('detailModal');
  updateUI();
}

// ===== CLIENTS =====
function openClientModal() {
  const body = document.getElementById('clientBody');
  if (state.clients.length === 0) {
    body.innerHTML = `<p style="color:var(--text-light);text-align:center;padding:16px">${t('noClients')}</p>`;
  } else {
    body.innerHTML = state.clients.map((c, i) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
        <span><span class="client-dot client-color-${i % 8}"></span> ${escHtml(c)}</span>
        <button class="btn btn-danger btn-sm" onclick="removeClient('${escHtml(c)}')">${t('removeClient')}</button>
      </div>
    `).join('');
  }
  openModal('clientModal');
}

function addClient() {
  const input = document.getElementById('newClientName');
  const name = input.value.trim();
  if (!name || state.clients.includes(name)) return;
  state.clients.push(name);
  input.value = '';
  saveState();
  updateUI();
  openClientModal();
}

function removeClient(name) {
  const hasOrders = state.orders.some(o => o.client === name);
  if (hasOrders) {
    alert(state.lang === 'en' ? 'Cannot remove client with active orders.' : 'Ğ˜Ğ´ÑĞ²Ñ…Ñ‚ÑĞ¹ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ³Ğ°Ñ‚Ğ°Ğ¹ Ğ·Ğ°Ñ…Ğ¸Ğ°Ğ»Ğ°Ğ³Ñ‡Ğ¸Ğ¹Ğ³ ÑƒÑÑ‚Ğ³Ğ°Ñ… Ğ±Ğ¾Ğ»Ğ¾Ğ¼Ğ¶Ğ³Ò¯Ğ¹.');
    return;
  }
  state.clients = state.clients.filter(c => c !== name);
  saveState();
  updateUI();
  openClientModal();
}

// ===== EXPORT / IMPORT =====
function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `sales-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.orders && data.clients) {
        migrateOrders(data.orders);
        state = data;
        saveState();
        updateUI();
        alert(state.lang === 'en' ? 'Data imported successfully!' : 'ĞœÑĞ´ÑÑĞ»ÑĞ» Ğ°Ğ¼Ğ¶Ğ¸Ğ»Ñ‚Ñ‚Ğ°Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ»Ğ¾Ğ³Ğ´Ğ»Ğ¾Ğ¾!');
      }
    } catch(err) {
      alert('Invalid file format');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ===== UTIL =====
function escHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
  });
});

// Keyboard shortcut
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
  }
});

// ===== INIT =====
// Show gate immediately to prevent flash of app data before auth resolves.
// onAuthStateChanged (above) calls loadState + updateUI + setupFirebaseSync after login.
showGate();
loadState(); // pre-load localStorage data so it's ready when auth resolves
</script>
</body>
</html>
